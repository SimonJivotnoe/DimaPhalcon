;(function(global,$){var Dima=function(){return new Dima.init();};var URL={BASE:'http://DimaPhalcon/DimaPhalcon/',TABS:'tabs/',CATEG:'categories/',ORDER:'order/',KIM:'kim/',METALLS:'metalls/',PRODUCT:'products/',MENU:'menu/',CLIENTS:'clients/',THEMES:'themes/',LOCATION:'http://DimaPhalcon/DimaPhalcon/'};var URL_TABS=URL.BASE+URL.TABS;var URL_CATEG=URL.BASE+URL.CATEG;var URL_ORDER=URL.BASE+URL.ORDER;var URL_KIM=URL.BASE+URL.KIM;var URL_METALLS=URL.BASE+URL.METALLS;var URL_PRODUCT=URL.BASE+URL.PRODUCT;var URL_MENU=URL.BASE+URL.MENU;var URL_CLIENTS=URL.BASE+URL.CLIENTS;var URL_THEMES=URL.BASE+URL.THEMES;var LOCATION=URL.LOCATION;var SELF;var MAIN;var TABS;var PRODUCT;var ORDER;var CATEGORIES;var KIM;var METALLS;var MENU;var PREFERENCES;var VALIDATION;var THEMES;var CLIENTS;var ERR={ARTICLE:{emptyTable:' Заполните поля таблицы продукта! ',checked:' Нужно отметить от 2-х до 4-х значений в таблице! ',already:'Такой артикул уже существует!',emptyName:' Задайте имя продукта! '}};var preferencesSettings=[{id:'#globalBodyColor',elem:'body',style:'backgroundColor',cssArr:['body']},{id:'#globalFontColor',elem:'body',style:'color',cssArr:['body']},{id:'#globalHRColor',elem:'hr',style:'border-color',cssArr:['hr']},{id:'#prefTabFontColor',elem:'#myTab li a',style:'color',cssArr:['#myTab li a','#rightTabs li a','#testTab li a']},{id:'#prefActiveTabColor',elem:'#testTab .active a',style:'backgroundColor',cssArr:['#myTab .active a','#rightTabs .active a','#testTab .active a']},{id:'#prefInactiveTabColor',elem:'#testTab li:not(.active) a',style:'backgroundColor',cssArr:['#myTab li:not(.active) a','#rightTabs li:not(.active) a','#testTab li:not(.active) a']},{id:'#prefDynProductTableColor',elem:'#prefSortable li',style:'backgroundColor',cssArr:['#sortable li, #prefSortable li']},{id:'#prefProductTableColor',elem:'#prefAlwaysInTable li',style:'backgroundColor',cssArr:['#alwaysInTable li, #prefAlwaysInTable li']},{id:'#prefDynProductFontColor',elem:'#prefSortable li .prefRowNumber',style:'color',cssArr:['#prefSortable li .prefRowNumber','#sortable li .rowNumber']},{id:'#prefProductFontColor',elem:'#prefAlwaysInTable li .prefRowNumber',style:'color',cssArr:['#prefAlwaysInTable li .prefRowNumber','#alwaysInTable li .rowNumber']},{id:'#prefDynProductCellFontColor',elem:'#prefSortable li .prefRowNameInput',style:'color',cssArr:['#prefSortable li .prefRowNameInput','#sortable li .rowNameInput']},{id:'#prefProductCellFontColor',elem:'#prefAlwaysInTable li .prefRowNameInput',style:'color',cssArr:['#prefAlwaysInTable li .prefRowNameInput','#alwaysInTable li .rowNameInput']},{id:'#prefDynProductCellBackground',elem:'#prefSortable li .prefRowNameInput',style:'backgroundColor',cssArr:['#prefSortable li .prefRowNameInput','#sortable li .rowNameInput'],important:true},{id:'#prefProductCellBackground',elem:'#prefAlwaysInTable li .prefRowNameInput',style:'backgroundColor',cssArr:['#prefAlwaysInTable li .prefRowNameInput','#alwaysInTable li .rowNameInput']},{id:'#prefDynProductQuantityColor',elem:'#prefSortable li .refRowValueInput',style:'color',cssArr:['#prefSortable li .refRowValueInput','#sortable li .rowValueInput']},{id:'#prefProductQuantityColor',elem:'#prefAlwaysInTable li .refRowValueInput',style:'color',cssArr:['#prefAlwaysInTable li .refRowValueInput','#alwaysInTable li .rowValueInput']},{id:'#prefDynProductQuantityBackground',elem:'#prefSortable li .refRowValueInput',style:'backgroundColor',cssArr:['#prefSortable li .refRowValueInput','#sortable li .rowValueInput']},{id:'#prefProductQuantityBackground',elem:'#prefAlwaysInTable li .refRowValueInput',style:'backgroundColor',cssArr:['#prefAlwaysInTable li .refRowValueInput','#alwaysInTable li .rowValueInput']},{id:'#prefOrderHeadBackground',elem:'#prefOrderTable tr:not(.orderTableSectionName) th',style:'backgroundColor',cssArr:['#prefOrderTable tr:not(.orderTableSectionName) th','#orderTable tr:not(.orderTableSectionName) th','.sumOrderTableHead']},{id:'#prefOrderHeadBordersColor',elem:'#prefOrderTable tr:not(.orderTableSectionName) th',style:'borderColor',cssArr:['#prefOrderTable tr:not(.orderTableSectionName) th','#orderTable tr:not(.orderTableSectionName) th','.sumOrderTableHead']},{id:'#prefOrderHeadFontColor',elem:'#prefOrderTable tr:not(.orderTableSectionName) th',style:'color',cssArr:['#prefOrderTable tr:not(.orderTableSectionName) th','#orderTable tr:not(.orderTableSectionName) th','.sumOrderTableHead']},{id:'#prefOrderSectionBackground',elem:'.orderTableSectionName th',style:'backgroundColor',cssArr:['.orderTableSectionName th','.withoutSectionInOrderTable th']},{id:'#prefOrderSectionBordersColor',elem:'.orderTableSectionName th',style:'borderColor',cssArr:['.orderTableSectionName th']},{id:'#prefOrderSectionFontColor',elem:'.orderTableSectionName th',style:'color',cssArr:['.orderTableSectionName th']},{id:'#prefOrderRowBackground',elem:'#prefOrderTable td',style:'backgroundColor',cssArr:['#prefOrderTable td','#orderTable td','.inputWithoutBorders','.sumOrderTableTd']},{id:'#prefOrderRowBordersColor',elem:'#prefOrderTable td',style:'borderColor',cssArr:['#prefOrderTable td','#orderTable td','.sumOrderTableTd']},{id:'#prefOrderRowFontColor',elem:'#prefOrderTable td',style:'color',cssArr:['#prefOrderTable td','#orderTable td','.sumOrderTableTd']}];var clickOnFormulaInput=false;var spinnerSettings={lines:15,length:0,width:10,radius:23,scale:1,corners:1,color:'#000',opacity:0,rotate:0,direction:1,speed:2.2,trail:47,fps:20,zIndex:2e9,className:'spinner',top:'50%',left:'50%',shadow:false,hwaccel:false,position:'absolute'};var spinnerLeft;var spinnerRight;var spinnerKim;var currentClietsTree;function run(){THEMES.getThemesList();spinnerLeft=new Spinner(spinnerSettings);spinnerRight=new Spinner(spinnerSettings);spinnerKim=new Spinner(spinnerSettings);spinnerLeft.spin(document.getElementById('leftTabsSpinner'));spinnerRight.spin(document.getElementById('rightTabsSpinner'));spinnerKim.spin(document.getElementById('kimSpinner'));var sector=localStorage.siteSector;if(!sector){localStorage.siteSector='MENU';MENU.showMainMenu();}else{switch(sector){case'MENU':MENU.showMainMenu();break;case'PR':MENU.runPreferences();break;case'DB':MENU.runDB();break;case'FM':break;case'OR':MENU.runProductCreation();break;default:$('#runPR').click();}}
addHandlerIndexHtml();}
function swap(sourceObj,sourceKey,targetObj,targetKey){var temp=sourceObj[sourceKey];sourceObj[sourceKey]=targetObj[targetKey];targetObj[targetKey]=temp;};function createProductFromTemplate(obj,action){var obj=(obj===undefined)?obj={prId:MAIN.productId,tab:'new'}:obj;var action=(action===undefined)?action=true:action;if('currentTab'===$('#selectCreateproductWay').val()){obj.tab=MAIN.curTabId;}
$.ajax({url:URL_PRODUCT+'createProductFromTemplate',method:'POST',data:obj}).then(function(data)
{console.log(data);if(true===data&&action){window.location.href=LOCATION;}});}
function cancelArticleBtn(){$('#createArticle').show();$('#cancelArticleBtn, #errorArticle').hide();$.each($('.checkToArticle'),function(key,val){if($(val).prop('checked')){$(this).click();};});$('.checkToArticle, #saveArticle').hide();$('#productArticle').html('');}
function recalculateArticleTable(){var selected=$('#metallHistorySelect option:selected');$('[data-cell="PR1"]').val(selected.attr('data-price'));$('[data-cell="PR2"]').val(selected.attr('data-outprice'));$('#calx').calx();$.each($('.rowValue input'),function(num,obj){var cell=$(obj).attr('data-cell');$('[data-cellarticle="'+cell+'"]').text($(obj).val());});}
var orderPlaceholder={"%FIO%":"","%PROJECT_NAME%":"","%APPEAL%":"","%PROJECT_DESCR%":"","%COMPANY_NAME%":"","%ADDRES%":"","%ACC_NUMBER%":"","%CITY%":"","%ESTIMATE%":"","%DATE%":""};var tempTable={"%ROW_NUMBER%":"","%ROW_NAME%":"","%DATA_CELL%":"","%DATA_FORMULA%":"","%INPUT_VALUE%":""};var notIncludeInCell=['KIM1','PR1','SUM1','PR2','SUM2'];var consolidateObj={sections:{},withoutSection:{},productsDetails:{}};function saveOrderMap(map,refresh){$.ajax({url:URL_MENU+'saveOrderMap',method:'POST',data:{map:map,orderId:MAIN.orderId}}).then(function(data)
{if(data&&refresh){TABS.getRightTabContentTable(MAIN.orderId);}});}
function setOrderSum(){var orderSum=0;var currency=' грн';$.each($('.outputSumInOrder'),function(num,obj){orderSum+=parseInt($(obj).text());});if($('#orderCurrencyUSDToggle').hasClass('activeCurrency')){currency=' USD';}
$('#orderSum').text(orderSum+currency);$('#orderSumWithDiscount').text(orderSum-orderSum*parseInt($('#changeDiscount').val())/100+currency);}
function swapRows(scope,area,dirr){var map=getOrderMap(),currentIndex=parseInt($(scope).attr('data-number')),swapIndex;switch(dirr){case'up':swapIndex=currentIndex-1;if(0===currentIndex){swapIndex=_.size(map[area])-1;}
break;case'down':swapIndex=currentIndex+1;if((_.size(map[area])-1)===currentIndex){swapIndex=0;}
break;}
swap(map[area],currentIndex,map[area],swapIndex);return map;}
function countProductInOrder(productId){var count=0;$.each(getOrderMap(),function(rowName,obj){$.each(obj,function(num,object){if(productId===_.keys(object)[0]){count++;}});});return count;}
function removeRowFromOrder(scope){var productId=$(scope).attr('name');if(1>=countProductInOrder(productId)){ORDER.removeFromOrder(productId);}
$(scope).closest('tr').remove();saveOrderMap(JSON.stringify(getOrderMap()),true);}
function buildConsolidateOrder(consolidateData){consolidateObj={sections:{},withoutSection:{},productsDetails:{}};$.each(consolidateData,function(orderId,obj){$.each(obj.map,function(section,secObj){if(_.size(secObj)){$.each(secObj,function(num,detSec){$.each(detSec,function(prId,quantity){if(!consolidateObj.sections[section]){consolidateObj.sections[section]={};}
if(!consolidateObj.sections[section][prId]){consolidateObj.sections[section][prId]={};}
if(!consolidateObj.sections[section][prId].quantity){consolidateObj.sections[section][prId].quantity=0;}
if(!consolidateObj.sections[section][prId].inPrices){consolidateObj.sections[section][prId].inPrices=[];}
if(!consolidateObj.sections[section][prId].outPrices){consolidateObj.sections[section][prId].outPrices=[];}
if(!consolidateObj.sections[section][prId].sum){consolidateObj.sections[section][prId].sum=[];}
if(!consolidateObj.sections[section][prId].inSum){consolidateObj.sections[section][prId].inSum=[];}
if(!consolidateObj.withoutSection[prId]){consolidateObj.withoutSection[prId]={};}
if(!consolidateObj.withoutSection[prId].quantity){consolidateObj.withoutSection[prId].quantity=0;}
if(!consolidateObj.withoutSection[prId].inPrices){consolidateObj.withoutSection[prId].inPrices=[];}
if(!consolidateObj.withoutSection[prId].outPrices){consolidateObj.withoutSection[prId].outPrices=[];}
if(!consolidateObj.withoutSection[prId].sum){consolidateObj.withoutSection[prId].sum=[];}
if(!consolidateObj.withoutSection[prId].inSum){consolidateObj.withoutSection[prId].inSum=[];}
consolidateObj.sections[section][prId].quantity+=parseInt(quantity);consolidateObj.withoutSection[prId].quantity+=parseInt(quantity);for(var i=1;i<=parseInt(quantity);i++){var data={};data[parseInt(consolidateData[orderId].products[prId].inSum)]=parseInt(consolidateData[orderId].products[prId].outSum);consolidateObj.sections[section][prId].inSum.push(parseInt(consolidateData[orderId].products[prId].inSum));consolidateObj.sections[section][prId].inPrices.push(parseInt(consolidateData[orderId].products[prId].inPrice));consolidateObj.sections[section][prId].outPrices.push(parseInt(consolidateData[orderId].products[prId].outPrice));consolidateObj.sections[section][prId].sum.push(data);consolidateObj.withoutSection[prId].inPrices.push(parseInt(consolidateData[orderId].products[prId].inPrice));consolidateObj.withoutSection[prId].outPrices.push(parseInt(consolidateData[orderId].products[prId].outPrice));data={};data[parseInt(consolidateData[orderId].products[prId].inSum)]=parseInt(consolidateData[orderId].products[prId].outSum);consolidateObj.withoutSection[prId].inSum.push(parseInt(consolidateData[orderId].products[prId].inSum));consolidateObj.withoutSection[prId].sum.push(data);}});});}});$.each(obj.products,function(prId,obj){if(!consolidateObj.productsDetails[prId]){consolidateObj.productsDetails[prId]={};}
consolidateObj.productsDetails[prId].article=obj.article;consolidateObj.productsDetails[prId].productName=obj.productName;});});$('#addNewSection').parent().remove();if(consolidateObj.sections){$.each(consolidateObj.sections,function(name,obj){if('out'===name){$(buildConsolidateAverageOrderTr(obj,'withoutSectionRow orderRow consAverageTr')).insertAfter('.withoutSectionInOrderTable');$(buildConsolidateOrderTr(obj,'withoutSectionRow orderRow consTr')).insertAfter('.withoutSectionInOrderTable');}else{$('<tr class="orderTableSectionName" name="'+name+'"><th colspan="9">'+name+'</th></tr>').insertBefore('.withoutSectionInOrderTable');$(buildConsolidateAverageOrderTr(obj,'orderTableSection orderRow consAverageTr')).insertAfter('[name="'+name+'"]');$(buildConsolidateOrderTr(obj,'orderTableSection orderRow consTr')).insertAfter('[name="'+name+'"]');}});$(buildConsolidateAverageOrderTr(consolidateObj.withoutSection,'withoutSectionRow orderRow consWithoutSectionAverageTr')).insertAfter('.withoutSectionInOrderTable');$(buildConsolidateOrderTr(consolidateObj.withoutSection,'withoutSectionRow orderRow consWithoutSectionTr')).insertAfter('.withoutSectionInOrderTable');}}
function buildConsolidateAverageOrderTr(obj,trClass){var count=1,rows=$();$.each(obj,function(prId,prObj){var product=consolidateObj.productsDetails[prId];var inPricesSum=0;var outPricesSum=0;var quantity=prObj.sum.length;$.each(prObj.sum,function(num,obj){inPricesSum+=parseInt(_.keys(obj)[0]);outPricesSum+=parseInt(obj[_.keys(obj)[0]]);});var inPrice=(inPricesSum/quantity).toFixed(2);var outPrice=(outPricesSum/quantity).toFixed(2);rows.push.apply(rows,buildConsOrderTr(trClass,count,product.article,product.productName,parseInt(prObj.quantity),inPrice,outPrice));count++;});return rows;}
function buildConsolidateOrderTr(obj,trClass){var rows=$();var count=1;$.each(obj,function(prId,prObj){var product=consolidateObj.productsDetails[prId];var sumRes={};var sum=_.clone(prObj.sum);$.each(sum,function(num,obj){var temp=_.clone(sum[0]);var quantity=1;sum.splice(0,1);var compare=_.clone(sum);$.each(compare,function(i,iObj){if(parseInt(_.keys(iObj)[0])===parseInt(_.keys(temp)[0])&&parseInt(iObj[_.keys(iObj)[0]])===parseInt(temp[_.keys(temp)[0]])){quantity++;sum.splice(0,1);}});if(!sumRes[quantity]){sumRes[quantity]=[];}
if(_.size(temp)){sumRes[quantity].push(temp);}});$.each(sumRes,function(quantity,arr){$.each(arr,function(num,obj){var inPrice=parseInt(_.keys(obj)[0]);var outPrice=obj[inPrice];rows.push.apply(rows,buildConsOrderTr(trClass,count,product.article,product.productName,quantity,inPrice,outPrice));count++;});});});return rows;}
function buildConsOrderTr(trClass,count,article,productName,quantity,inPrice,outPrice){var tr=$('<tr></tr>').addClass(trClass);tr.append('<td class="orderNumberTd">'+count+'</td><td class="orderArticleTd">'+article+'</td><td class="orderProductNameTd">'+productName+'</td>');tr.append('<td class="orderUnitOfMeasureTd">шт</td><td class="quantityInOrderTd">'+quantity+'</td><td class="inputPriceInOrder" data-uah="'+inPrice+'">'+inPrice+'</td>');tr.append('<td class="inputSumInOrder" data-uah="'+quantity*inPrice+'">'+quantity*inPrice+'</td>');tr.append('<td class="outputPriceInOrder" data-uah="'+outPrice+'">'+outPrice+'</td>');tr.append('<td class="outputSumInOrder" data-uah="'+quantity*outPrice+'">'+quantity*outPrice+'</td>');return tr;}
function buildOrderDetailsPDF(){var i=-1;var tempObj={widths:['50%','50%'],table:{body:[]},layout:'noBorders',fontSize:11};var body=tempObj.table.body;var tempDetArr=[];$.each($('.orderDetailsItem'),function(num,obj){var itemText=$(obj).find('label').text();var itemName=$(obj).find('label input').attr('name');var check=$(obj).find('label input').prop('checked');var itemDetails=$(obj).find('.inputOrderDetails').val();if(check){if('orderNumber'===itemName){tempDetArr.push(itemText+$('[aria-controls='+MAIN.curTabRightId+']').find('.tabNameRight').text());}else{tempDetArr.push(itemText+itemDetails);}
i++;}
if((0<i&&1===(i%2))||num===$('.orderDetailsItem').length-1){body.push(tempDetArr);tempDetArr=[];}});if(1===body[body.length-1].length){body[body.length-1].push('');}
return tempObj;}
function saveOrderToPDF(){var orderName=$('[aria-controls='+MAIN.curTabRightId+']').find('.tabNameRight').text();var pdfName=orderName+'.pdf';if(!pdfName){pdfName='Ордер.pdf';}
var content=[{text:'Счет-фактура №'+orderName,style:'header',alignment:'center',margin:[0,0,0,50]}];content.push(buildOrderDetailsPDF());var tempObj={table:{body:[[]]},margin:[0,30,0,30],alignment:'center',style:{fontSize:11}};var checkedOrderHead=[];var body=tempObj.table.body;var preWidths=[];$.each($('#orderHeadChecks input'),function(num,obj){var thText=$(obj).attr('data-head');var thName=$(obj).attr('name');var check=$(obj).prop('checked');var width=$(obj).closest('th').width();if(check){body[0].push({text:thText,style:{bold:true,fontSize:11,color:'black'}});checkedOrderHead.push(thName);preWidths.push(width);}
if(num===$('#orderHeadChecks input').length-1){content.push(_.clone(tempObj));}});tempObj.table.widths=[];var hundredWidth=_.reduce(preWidths,function(memo,num){return memo+num;},0);$.each(preWidths,function(num,px){tempObj.table.widths.push(px/hundredWidth*100+'%');});var totalProducts=0;var totalQuantity=0;var orderMap=getExtendedOrderMap();$.each(orderMap,function(section,arr){if('out'!==section){body.push([{text:section,colSpan:checkedOrderHead.length,alignment:'center'}]);$.each(arr,function(id,obj){var tr=[];totalProducts++;$.each(obj,function(td,text){if(-1!==checkedOrderHead.indexOf(td)){if('orderProductNameTd'===td){tr.push({text:text,alignment:'left'});}else{tr.push(text);}
if('quantityInOrderTd'===td){totalQuantity+=parseInt(text);}}});body.push(tr);});}});$.each(orderMap,function(section,arr){if('out'===section){body.push([{text:'\n',colSpan:checkedOrderHead.length,alignment:'center'}]);$.each(arr,function(id,obj){var tr=[];totalProducts++;$.each(obj,function(td,text){if(-1!==checkedOrderHead.indexOf(td)){if('orderProductNameTd'===td){tr.push({text:text,alignment:'left'});}else{tr.push(text);}
if('quantityInOrderTd'===td){totalQuantity+=parseInt(text);}}});body.push(tr);});}});content.push({table:{body:[[{text:'Итого: ',style:{bold:true}},{text:$('#orderSum').text()}],[{text:'Сумма с дисконтом: ',style:{bold:true}},{text:$('#orderSumWithDiscount').text()}],[{text:'Количество изделий: ',style:{bold:true}},{text:''+totalQuantity+'шт'}]],alignment:'right'},margin:[315,20,0,0],layout:'noBorders'});var docDefinition={content:content,styles:{header:{fontSize:20,bold:true},subheader:{fontSize:12,bold:true},tableHeader:{bold:true,fontSize:12,color:'black'}},defaultStyle:{columnGap:50}};pdfMake.createPdf(docDefinition).download(pdfName);}
function log(php){if('undefined'!==typeof(console)){console.error('ERROR in '+php);}}
function showBody(){PREFERENCES.applyCss();if($('body').is(":visible")){return false;}
$('body').fadeIn(350);return true;}
function kimEditOver(obj,scope){$('.glyphicon-pencil',scope).removeClass(obj.pencilRemove).addClass(obj.pencilAdd);$('.glyphicon-remove',scope).removeClass(obj.removeRemove).addClass(obj.removeAdd);}
function changeActiveTab(obj){var scope=obj.scope,selectedTabId=$(scope).attr('aria-controls'),curTabId=obj.curTabId,tabsList=obj.tabsList,tabId,prodId,orderId;if(''!==MAIN[curTabId]){MAIN[tabsList][MAIN[curTabId]].active='0';}
if(MAIN[curTabId]!==selectedTabId&&undefined!==selectedTabId){tabId=$(scope).find('.glyphicon-remove').attr('name');prodId=$(scope).attr('name');MAIN[tabsList][selectedTabId].active='1';if(obj.hasOwnProperty('order')){orderId=$(scope).attr('data-order');TABS.getRightTabContentOrderDetails(orderId,selectedTabId);TABS.getRightTabContentTable(orderId);}else{TABS[obj.getTabContent](prodId,selectedTabId);}
TABS[obj.changeActiveTab](tabId,selectedTabId,obj.action);}}
function editDescriptionOfProduct(bool){var obj={};$('.nameOfProduct, .listOfCategories, .listOfKim, .listOfMetalls').prop('disabled',bool);if(!bool){return true;}
obj.prName=$('.nameOfProduct').val(),obj.categoryId=$('.listOfCategories option:selected').attr('name'),obj.kimId=$('.listOfKim option:selected').attr('name'),obj.metallId=$('.listOfMetalls option:selected').attr('name');return obj;}
function getOrderMap(){var res={};res.out=[];var name;$.each($('#orderTable tr'),function(key,val){switch($(val).attr('class')){case'skip':break;case'orderTableSectionName':name=$(val).attr('name');res[name]=[];break;case'orderTableSection orderRow':var productId=$(val).attr('name'),obj={};$.each($('td',val),function(k,v){if('quantityInOrderTd'===$(v).attr('class')){obj[productId]=$('input',v).val();res[name].push(obj);}});break;case'withoutSectionRow orderRow':var productId=$(val).attr('name'),obj={};$.each($('td',val),function(k,v){if('quantityInOrderTd'===$(v).attr('class')){obj[productId]=$('input',v).val();res.out.push(obj);}});break;default:break;}});return res;}
function getExtendedOrderMap(){var res={};res.out=[];var name,extraClass='';if(store.get('consOrder')){extraClass=' '+store.get('consOrder');}
$.each($('#orderTable tr'),function(key,val){switch($(val).attr('class')){case'skip':break;case'orderTableSectionName':name=$(val).attr('name');res[name]=[];break;case'orderTableSection orderRow'+extraClass:var obj={},data={};$.each($('td',val),function(k,v){if('orderTableActions'!==$(v).attr('class')){if(!extraClass){if('quantityInOrderTd'===$(v).attr('class')){data[$(v).attr('class')]=$('input',v).val();}else{data[$(v).attr('class')]=$(v).text();}}else{data[$(v).attr('class')]=$(v).text();}}});res[name].push(data);break;case'withoutSectionRow orderRow'+extraClass:var obj={},data={};$.each($('td',val),function(k,v){if('orderTableActions'!==$(v).attr('class')){if(!extraClass){if('quantityInOrderTd'===$(v).attr('class')){data[$(v).attr('class')]=$('input',v).val();}else{data[$(v).attr('class')]=$(v).text();}}else{data[$(v).attr('class')]=$(v).text();}}});res.out.push(data);break;default:break;}});return res;}
function enableDisableButton(id,button){if(0<id.size()){if(button.prop('disabled')){button.prop('disabled',false);}}else{button.prop('disabled',true);}}
function checkInputsInClientsDetails(scope){var check=0;$.each($(scope),function(num,input){var $input=$(input);if($input.val()){check++;}});return check;}
function addHandlerIndexHtml(){$('#findInClietsTree').keyup(function(){var tree=JSON.parse($('#clientsTree').tree('toJson')),text=$(this).val().toLowerCase();if(!text){$('#clientsTree > ul > li').show();}else{$('#clientsTree > ul > li').hide();MENU.searchInTree(tree,text);}});$('#addNewClient').click(function(){var check=0;$('#clientsTree').tree('selectNode');if($('#h3NewClientInfo').is(':visible')){check=checkInputsInClientsDetails('#addNewClientForm input');}
if(0===check){MENU.fillFormOfClientsInfo();}});$('#addNewClientBtn').click(function(){var check=0,data={};$.each($('#addNewClientForm input'),function(num,input){var $input=$(input);data[$input.attr('name')]=$input.val();if(!VALIDATION.validateInputVal({val:$input.val(),id:'#'+$input.attr('id')})){check++;}});if(!check){$.ajax({url:URL_MENU+'addNewClient',method:'POST',data:data}).then(function(data)
{if(data){$('#addNewClientForm input').val('');CLIENTS.getClientsTree(true);}});}});$('#updateClientBtn').click(function(){var $tree=$('#clientsTree');if($tree.tree('getSelectedNode').clientId){var check=0,data={id:$tree.tree('getSelectedNode').clientId};$.each($('#addNewClientForm input'),function(num,input){var $input=$(input);data[$input.attr('name')]=$input.val();if(!VALIDATION.validateInputVal({val:$input.val(),id:'#'+$input.attr('id')})){check++;}});if(!check){$.ajax({url:URL_CLIENTS+'updateClient',method:'POST',data:data}).then(function(data)
{if(data){CLIENTS.getClientsTree(true);PRODUCT.getClientsDetails();noty({text:'Информация обновлена',type:'success',layout:'center',timeout:600});}});}}});$('#deleteClientBtn').click(function(){var selectedNode=$('#clientsTree').tree('getSelectedNode');if(selectedNode&&selectedNode.clientId){noty({text:'Вы уверены, что хотите удалить Клиента? При удалении Клиента, будут удалены все проекты и ордера, принадлежащие данному Клиенту.',modal:true,type:'confirm',layout:'center',animation:{open:'animated flipInX',close:'animated flipOutX'},buttons:[{addClass:'btn btn-success',text:'Удалить!',onClick:function($noty){$.when(CLIENTS.deleteClient(selectedNode.clientId)).then(function(data){$noty.close();});}},{addClass:'btn btn-danger',text:'Передумал',onClick:function($noty){$noty.close();}}]});}});$('#addNewProject').click(function(){var data={},check=0;var selectedNode=$('#clientsTree').tree('getSelectedNode');if($('#h3NewProjectInfo').is(':visible')){check=checkInputsInClientsDetails('#addNewProjectForm input');}
if(0===check&&selectedNode){MENU.fillFormOfProjectInfo();}else{noty({text:'Выберите Клиента',type:'error',layout:'center',timeout:900});}});$('#addNewProjectBtn').click(function(){var selectedNode=$('#clientsTree').tree('getSelectedNode');if(selectedNode&&selectedNode.clientId){var check=0,data={client:selectedNode.clientId};$.each($('#addNewProjectForm input'),function(num,input){var $input=$(input);data[$input.attr('name')]=$input.val();if(!VALIDATION.validateInputVal({val:$input.val(),id:'#'+$input.attr('id')})){check++;}});if(!check){$.ajax({url:URL_MENU+'addNewProject',method:'POST',data:data}).then(function(data)
{if(data){$('#addNewProjectForm input').val('');CLIENTS.getClientsTree(true);}});}}});$('#updateProjectBtn').click(function(){var $tree=$('#clientsTree');if($tree.tree('getSelectedNode').projectId){var check=0,data={id:$tree.tree('getSelectedNode').projectId};$.each($('#addNewProjectForm input'),function(num,input){var $input=$(input);data[$input.attr('name')]=$input.val();if(!VALIDATION.validateInputVal({val:$input.val(),id:'#'+$input.attr('id')})){check++;}});if(!check){$.ajax({url:URL_CLIENTS+'updateProject',method:'POST',data:data}).then(function(data)
{if(data){CLIENTS.getClientsTree(true);PRODUCT.getClientsDetails();noty({text:'Информация обновлена',type:'success',layout:'center',timeout:600});}});}}});$('#deleteProjectBtn').click(function(){var selectedNode=$('#clientsTree').tree('getSelectedNode');if(selectedNode&&selectedNode.projectId){noty({text:'Вы уверены, что хотите удалить Проэкт? При удалении Проэкта, будут удалены все ордера, принадлежащие данному Проэкту.',modal:true,type:'confirm',layout:'center',animation:{open:'animated flipInX',close:'animated flipOutX'},buttons:[{addClass:'btn btn-success',text:'Удалить!',onClick:function($noty){$.when(CLIENTS.deleteProject(selectedNode.projectId)).then(function(data){$noty.close();});}},{addClass:'btn btn-danger',text:'Передумал',onClick:function($noty){$noty.close();}}]});}});$('#addNewOrder').click(function(){var $tree=$('#clientsTree');if($tree.tree('getSelectedNode').projectId){$.when(ORDER.createNewOrder($tree.tree('getSelectedNode').projectId,false)).done(function(){CLIENTS.getClientsTree(true);});}else{noty({text:'Выберите Проэкт',type:'error',layout:'center',timeout:900});}});}
function addLeftTabContentHandler(html){html.find('#uploadImageProduct').click(function(e){$('#input-file-upload').trigger('click');}).end().find('#input-file-upload').change(function(){if(!window.File||!window.FileReader||!window.FileList||!window.Blob){window.alert("Can't upload! Your browser does not support File API!");return;}
var fileReader=new FileReader();var filter=/^(?:image\/bmp|image\/cis\-cod|image\/gif|image\/ief|image\/jpeg|image\/jpeg|image\/jpeg|image\/pipeg|image\/png|image\/svg\+xml|image\/tiff|image\/x\-cmu\-raster|image\/x\-cmx|image\/x\-icon|image\/x\-portable\-anymap|image\/x\-portable\-bitmap|image\/x\-portable\-graymap|image\/x\-portable\-pixmap|image\/x\-rgb|image\/x\-xbitmap|image\/x\-xpixmap|image\/x\-xwindowdump)$/i;if(this.files.length==0){window.alert('Нужно выбрать файл');return;}
var file=this.files[0];var size=file.size;var type=file.type;if(!filter.test(type)){window.alert('Формат файла не поддерживается');return;}
var max=2000000;if(size>max){window.alert('Файл больше чем 2 MB');return;}
$('.upload-image').show();$('#uploadImageProduct').hide();var formData=new FormData();formData.append('image_data',file);$.ajax({type:'POST',processData:false,contentType:false,url:URL_PRODUCT+'uploadImage/'+MAIN.productId,data:formData,dataType:'json',success:function(data){$('.upload-image').hide();$('#uploadImageProduct, #productPicture').show();if(data){TABS.getLeftTabContent(MAIN.productId,MAIN.curTabId);}}});}).end().filter('.blockNameAndCat').mouseover(function(){$('#editCategoriesListContent').show();}).mouseleave(function(){$('#editCategoriesListContent').css('display','none');}).end().filter('.tableContent').mouseover(function(){$('#editTableContent').show();}).mouseleave(function(){$('#editTableContent').css('display','none');}).end().on('click','#editCategoriesListContent',function(){cancelArticleBtn();$(this).attr({class:'glyphicon glyphicon-floppy-disk',id:'saveCategoriesListContent'});editDescriptionOfProduct(false);}).on('click','#saveCategoriesListContent',function(){var obj;$(this).attr({class:'glyphicon glyphicon-pencil leftTable',id:'editCategoriesListContent'});obj=editDescriptionOfProduct(true);if(''===obj.prName){obj.prName='Новое изделие';$(MAIN.curTabName).text('Новое изделие');}
TABS.changeTabName(obj);PRODUCT.saveTable();}).find('#createArticle').click(function(){var check=0,rowValueInput,categoryArticle=$('.listOfCategories option:selected').attr('article'),metallArticle=$('.listOfMetalls option:selected').attr('article');$('#saveCategoriesListContent, #saveTableContent').click();$('#productArticle').html(categoryArticle+metallArticle);$.each($('.checkToArticle'),function(k,v){rowValueInput=$(v).closest('li').find('.rowValueInput');if(rowValueInput.val()){check++;$(this).show();}});if(check){$('#saveArticle, #cancelArticleBtn').show();$('#errorArticle').hide();$(this).hide();}else{$('#errorArticle').text(ERR.ARTICLE.emptyTable).show();setTimeout(function(){$('#errorArticle').text('').hide('slow');},2000);}}).end().find('#saveArticle').click(function(){var checkCount=0,check=true,productName=true,rowValueInput,errorMessage='';$.each($('.checkToArticle'),function(k,v){rowValueInput=$(v).closest('li').find('.rowValueInput');if($(v).prop('checked')){checkCount++;}});if(!$('.nameOfProduct').val()){productName=false;errorMessage+=ERR.ARTICLE.emptyName;}
if(2>checkCount||4<checkCount){check=false;errorMessage+=ERR.ARTICLE.checked;}
if(check&&productName){if($('#saveInDB').size()){}
PRODUCT.saveArticleOfProduct($('#productArticle').text());}else{$('#errorArticle').text(errorMessage).show();setTimeout(function(){$('#errorArticle').text('').hide('slow');},2000);}}).end().find('#cancelArticleBtn').click(cancelArticleBtn).end().find('#metallHistorySelect').change(recalculateArticleTable).end().on('change','.checkToArticle',function(){var val=$(this).closest('li').find('.rowValueInput').val(),cell=$(this).closest('li').find('.rowNumber').text(),appendSpan;if($(this).prop('checked')){if(val){appendSpan=$('<span articlepart="'+cell+'" style="display: none;">'+
VALIDATION.validateInputVal({val:val,digitsOnly:true})+'</span>');$('#productArticle').append(appendSpan);appendSpan.show('slow');}}else{$.each($('#productArticle span'),function(key,val){if(cell===$(val).attr('articlepart')){$(val).slideUp();setTimeout(function(){$(val).remove();},400);}});}}).on('click','#editTableContent',function(){cancelArticleBtn();$(this).attr({class:'glyphicon glyphicon-floppy-disk',id:'saveTableContent'});$('.checkToArticule').hide();$('.removeRow').show();$('#sortable').sortable({revert:true});$('#sortable').sortable("enable");}).on('click','#saveTableContent',function(){$(this).attr({class:'glyphicon glyphicon-pencil leftTable',id:'editTableContent'});$('.removeRow').hide();$('.checkToArticule').show();PRODUCT.saveTable();$('#sortable').sortable({revert:false});$('#sortable').sortable('disable');}).find('#saveInDB').click(function(){PRODUCT.saveProductInDB();}).end().find('#addToOrderBtn').click(function(){if(!MAIN.orderId){localStorage.addToOrder=MAIN.productId;$('.rowValue input').addClass('rowValueInput');localStorage.alwaysInTable=JSON.stringify(PRODUCT.getTableContent('#alwaysInTable li'));;$('.rowValueInput').removeClass('rowValueInput');ORDER.createNewOrder();return true;}
ORDER.addToOrder();}).end().find('#createProductFromTemplate').click(function(){createProductFromTemplate();}).end().find('.nameOfProduct').on('change, keyup',function(){$(MAIN.curTabName).text($(this).val());if(''===$(this).val()){$(MAIN.curTabName).text('Новое изделие');}}).end().find('.listOfKim').change(function(){var kim=$('option:selected',this).attr('kim');$('[data-cell="KIM1"]').val(kim);$('#calx').calx();}).end().find('.listOfMetalls').change(function(){var metall=$('option:selected',this).attr('metall');var metallOut=$('.listOfMetalls option:selected').attr('metallOut');$('[data-cell="PR1"]').val(metall);$('[data-cell="PR2"]').val(metallOut);$('#calx').calx();}).end().find('#addNewRow').click(function(){var numbersOfRows=$('#duration').val(),tableContent={},temp,alwaysInTable,arr=[],max=0,i;cancelArticleBtn();if(0===$('#sortable li').size()){for(i=0;i<numbersOfRows;i++){temp=_.clone(tempTable);temp['%ROW_NUMBER%']='A'+(i+1);temp['%DATA_CELL%']='A'+(i+1);tableContent[i]=temp;}
alwaysInTable=PRODUCT.getTableContent('#alwaysInTable li');PRODUCT.createTable(tableContent,alwaysInTable);}else{$.each($('#sortable .rowNumber'),function(key,val){if(''!==$(val).text()){arr.push(parseInt($(val).text().substring(1)));}});if(0!==arr.length){max=Math.max.apply(Math,arr);}
tableContent=PRODUCT.getTableContent('#sortable li');for(var i=0;i<numbersOfRows;i++){temp=_.clone(tempTable);temp['%ROW_NUMBER%']='A'+(max+1);temp['%DATA_CELL%']='A'+(max+1);tableContent[max]=temp;max++;}
alwaysInTable=PRODUCT.getTableContent('#alwaysInTable li');PRODUCT.createTable(tableContent,alwaysInTable);}}).end().on('click','.removeRow',function(){var rowName=$(this).parent().find('.rowValueInput').attr('data-cell'),checkBinding=$('.list-group-item').find('.glyphicon:contains('+rowName+')');checkBinding.length?checkBinding.remove():0;$(this).parent().hide('drop');$(this).parent().find('.rowNumber').text('');$(this).parent().find('.rowValueInput').attr('data-cell','');setTimeout(function(){$(this).parent().remove();},500);}).on('keyup','.rowNameInput',function(){$(this).attr('value',$(this).val());PRODUCT.saveTable();}).on('mousewheel','.rowValueInput',function(e){var thisVal=Number($(this).val());if(1===e.deltaY){$(this).val((thisVal+0.01).toFixed(2)).attr('value',(thisVal+0.01).toFixed(2));}else if(-1===e.deltaY){$(this).val((thisVal-0.01).toFixed(2)).attr('value',(thisVal-0.01).toFixed(2));}
$('#calx').calx();PRODUCT.saveTable();}).on('keydown','.rowValueInput',function(e){switch(e.keyCode){case 38:PRODUCT.catchKey(this,'+',1);e.preventDefault();break;case 40:PRODUCT.catchKey(this,'-',1);e.preventDefault();break;case 191:PRODUCT.catchKey(this,'+',10);e.preventDefault();break;case 17:PRODUCT.catchKey(this,'-',10);e.preventDefault();break;case 190:PRODUCT.catchKey(this,'+',100);e.preventDefault();break;case 18:PRODUCT.catchKey(this,'-',100);e.preventDefault();break;case 32:e.preventDefault();break;}}).on('keyup','.rowValueInput',function(e){var notToReact=[17,18,32,37,38,39,40,110,188,190,191],text=$(this).val(),caretPos;if(text.indexOf(',')!==-1){text=text.replace(',','.');$(this).val(text);}
$(this).attr('value',text);if(-1===$.inArray(e.keyCode,notToReact)){caretPos=this.selectionStart;if(96===e.keyCode&&'.'===text.charAt((text.length-2))){}else{$('#calx').calx();text=''+$(this).val();$(this).caret(caretPos);if('.'===text.charAt((text.length-2))){$(this).caret((text.length-1));}
PRODUCT.saveTable();}}}).find('#addFormulaBtnPr').click(function(){if(''!==$('#addFormulaInputPr').val()){$('#formulasList').append('<li class="list-group-item formula"><span class="formulaValue">'
+$('#addFormulaInputPr').val()+'<span class="glyphicon glyphicon-resize-small bindFormulaWithCell" aria-hidden="true"></span></span><span class="addAvailableCellList">'+PRODUCT.addAvailableCellList($('#addFormulaInputPr').val())+'</span>'+'<span class="glyphicon glyphicon-pencil editFormula" aria-hidden="true"></span><span class="glyphicon glyphicon-remove removeFormula" aria-hidden="true"></span></li>');$('.removeFormula').hide();$('.editFormula').hide();PRODUCT.cancelInputFormula();$('#addFormulaInputPr').val('');PRODUCT.addNewFormula(PRODUCT.getFormulasList,true);}}).end().find('#addFormulaInputPr').click(function(){var currentVal,ls;localStorage.currentCaretPos=document.getElementById('addFormulaInputPr').selectionStart;$('#addNewFhBtnInput').val('');if(!clickOnFormulaInput){clickOnFormulaInput=true;$('.removeFhBtn').hide();$('#addFormulaInputPr').css('border-color','rgba(82, 168, 236, 0.8)');$('#formulasHelper').show('scale');$('#addFormulaBtnPr').hide();$('.formulaBtnGroupPr').show('drop');$('body').css('cursor','pointer');$('.currentTab ').attr('tabindex','1').css('outline','none');$('.currentTab ').unbind('keydown').bind('keydown',function(e){if(e.keyCode===8){currentVal=$('#addFormulaInputPr').val();ls=localStorage.currentCaretPos;currentVal=PRODUCT.removeChar(currentVal,ls-1);$('#addFormulaInputPr').val(currentVal);localStorage.currentCaretPos--;e.preventDefault();}}).unbind('keypress').bind('keypress',function(e){if(!$('#addFormulaInputPr').is(":focus")){if(32!==e.keyCode){PRODUCT.addWhereCaret(localStorage.currentCaretPos,String.fromCharCode(e.keyCode));localStorage.currentCaretPos++;}}}).unbind('keyup').bind('keyup',function(){PRODUCT.toggleAddFormula();localStorage.currentCaretPos=document.getElementById('addFormulaInputPr').selectionStart;}).off('click').on('click','.rowNumber',function(){PRODUCT.addElementToFormulaInput(this);});}}).keydown(function(e){if(32===e.keyCode){return false;}}).end().find('#cancelFormulaBtnPr').click(function(){PRODUCT.cancelInputFormula();}).end().on('click','.fhBtn',function(){PRODUCT.addElementToFormulaInput(this);}).on('mouseover','.fhBtn',function(){$('.removeFhBtn',this).show('fast');}).on('mouseleave','.fhBtn',function(){$('.removeFhBtn',this).hide('fast');}).on('click','.removeFhBtn',function(e){e.stopPropagation();e.preventDefault();var fhText=$(this).parent().text();PRODUCT.removeFormulasHelper(this,fhText);}).on('click','.addNewFhBtn',function(){var newFl=$('#addNewFhBtnInput').val();$('body').css('cursor','pointer');$('#addFormulaInputPr').click();PRODUCT.addBtnToFormulasHelper(newFl);}).on('click','#addNewFhBtnInput',function(){clickOnFormulaInput=false;$('.currentTab ').unbind('keydown keypress keyup');$('body').off('keypress').css('cursor','auto');}).find('.removeFormula').hide().end().find('.editFormula').hide().end().find('.bindFormulaWithCell').click(function(){var li=$(this).closest('li'),cellStatus=li.find('.addAvailableCellList option:selected').attr('val'),cell=li.find('.addAvailableCellList option:selected').val(),formula=li.find('.formulaValue').text(),cellList=li.find('.addAvailableCellList');if('true'===cellStatus&&cell){$('[data-cell="'+cell+'"]').attr('data-formula',formula);$('#calx').calx();cellList.remove();$('<span class="glyphicon glyphicon-retweet cellBind" aria-hidden="true"> '+cell+'</span>').insertAfter($(this));$(this).remove();PRODUCT.addNewFormula(PRODUCT.getFormulasList,true);}}).end().on('click','.removeFormula',function(){var bindCell=$(this).parent().find('.cellBind'),tableContent,alwaysInTable,flag=false;if(bindCell.length){PRODUCT.removeBindingFormulaFromTable(false,bindCell.text());tableContent=PRODUCT.getTableContent('#sortable li');alwaysInTable=PRODUCT.getTableContent('#alwaysInTable li');PRODUCT.createTable(tableContent,alwaysInTable);flag=true;}
$(this).closest('li').hide("slide",{},function(){$(this).remove();setTimeout(function(){PRODUCT.addNewFormula(PRODUCT.getFormulasList,flag);},400);});}).on('click','.editFormula',function(){var formula=$(this).closest('li').find('.formulaValue').text();$(this).closest('li').find('.removeFormula').click();$('#addFormulaInputPr').click().val(formula);PRODUCT.toggleAddFormula();}).on('mouseover','.list-group-item',function(){$(this).addClass('list-group-item-info');$(this).find('.removeFormula').show();$(this).find('.editFormula').show();}).on('mouseleave','.list-group-item',function(){$(this).removeClass('list-group-item-info');$(this).find('.removeFormula').hide();$(this).find('.editFormula').hide();}).on('mouseover','.glyphicon-retweet',function(){$(this).removeClass('glyphicon glyphicon-retweet').addClass('glyphicon glyphicon-resize-full');}).on('mouseleave','.glyphicon-resize-full',function(){$(this).removeClass('glyphicon glyphicon-resize-full').addClass('glyphicon glyphicon-retweet');}).on('click','.glyphicon-resize-full',function(e){var bindCell=$(this).text(),tableContent,alwaysInTable;e.stopPropagation();e.preventDefault();PRODUCT.removeBindingFormulaFromTable(this,bindCell);PRODUCT.addNewFormula(PRODUCT.getFormulasList,true);tableContent=PRODUCT.getTableContent('#sortable li');alwaysInTable=PRODUCT.getTableContent('#alwaysInTable li');PRODUCT.createTable(tableContent,alwaysInTable);});return html;}
function addLeftTabsHandler(html){html.find('[role=tab], #dbProductsListList').click(function(){if($(this).attr('aria-controls')!==MAIN.curTabId){changeActiveTab({scope:this,curTabId:'curTabId',tabsList:'tabsList',getTabContent:'getLeftTabContent',changeActiveTab:'changeActiveTab',action:'changeActiveLeftTab'});}}).end().find('.closeTab').click(function(e){e.stopPropagation();e.preventDefault();var currentID=$(this).parent().attr('aria-controls'),idDb=$(this).attr('name');$(this).attr('class','glyphicon glyphicon-remove');TABS.closeLeftTab(idDb,currentID);});}
function addRightTabsHandler(html){html.find('[role=tab]').click(function(){if($(this).attr('aria-controls')!==MAIN.curTabRightId){changeActiveTab({scope:this,order:true,curTabId:'curTabRightId',tabsList:'tabsRightList',getTabContent:'getRightTabContent',changeActiveTab:'changeActiveTab',action:'changeActiveRightTab'});}}).end().find('.closeTabRight ').click(function(e){e.stopPropagation();var currentID=$(this).parent().attr('data-order'),idDb=$(this).attr('name');$(this).attr('class','glyphicon glyphicon-remove');TABS.closeRightTab(idDb,currentID);}).end();return html;}
function addRightTabContentOrderHandler(html){html.find('#saveOrderInDB').click(function(){ORDER.saveOrderInDB();}).end().find('#createPDF').click(saveOrderToPDF).end().find('#checkAllInOrder').click(function(){ORDER.checkAllInOrderDetails(true);}).end().find('#uncheckAllInOrder').click(function(){ORDER.checkAllInOrderDetails(false);}).end().find('#changeDiscount').click(function(){ORDER.changeDiscount({discount:$(this).val(),orderId:MAIN.orderId});setOrderSum();}).end().find('.inputOrderDetails').keyup(function(){var obj=ORDER.createJSONFromOrderDescription();ORDER.changeOrderDetails({orderId:MAIN.orderId,orderDescr:obj});}).end().find('#consAveragePrices').click(function(){if($(this).hasClass('uniquePrices')){$(this).removeClass('uniquePrices');$(this).text('Уникальные цены');if($('#consRemoveSections').hasClass('showSections')){$('.consTr, .consAverageTr, .consWithoutSectionTr').hide();$('.consWithoutSectionAverageTr').show();store.set('consOrder','consWithoutSectionAverageTr');}else{$('.consTr, .consWithoutSectionTr, .consWithoutSectionAverageTr').hide();$('.consAverageTr').show();store.set('consOrder','consAverageTr');}}else{$(this).addClass('uniquePrices');$(this).text('Средние цены');if($('#consRemoveSections').hasClass('showSections')){$('.consTr, .consAverageTr, .consWithoutSectionAverageTr').hide();$('.consWithoutSectionTr').show();store.set('consOrder','consWithoutSectionTr');}else{$('.consAverageTr, .consWithoutSectionTr, .consWithoutSectionAverageTr').hide();$('.consTr').show();store.set('consOrder','consTr');}}}).end().find('#consRemoveSections').click(function(){if($(this).hasClass('showSections')){$(this).removeClass('showSections');$(this).text('Убрать разделы');$('.orderTableSectionName').show();setTimeout(function(){$('.orderTableSectionName').removeClass('skip');},10);if($('#consAveragePrices').hasClass('uniquePrices')){$('.consWithoutSectionTr, .consAverageTr, .consWithoutSectionAverageTr').hide();$('.consTr').show();store.set('consOrder','consTr');}else{$('.orderTableSectionName').addClass('skip');$('.consWithoutSectionTr, .consTr, .consWithoutSectionAverageTr').hide();$('.consAverageTr').show();store.set('consOrder','consAverageTr');}}else{$(this).addClass('showSections');$(this).text('Показать разделы');$('.orderTableSectionName').addClass('skip').hide();if($('#consAveragePrices').hasClass('uniquePrices')){$('.consAverageTr, .consTr, .consWithoutSectionAverageTr').hide();$('.consWithoutSectionTr').show();store.set('consOrder','consWithoutSectionTr');}else{$('.consWithoutSectionTr, .consTr, .consAverageTr').hide();$('.consWithoutSectionAverageTr').show();store.set('consOrder','consWithoutSectionAverageTr');}}}).end().find('#orderEstimateInput, #orderDateInput').on('keyup, click, change',function(){var obj=ORDER.createJSONFromOrderDescription();ORDER.changeOrderDetails({orderId:MAIN.orderId,orderDescr:obj});}).end().find('#orderCurrencyUAHToggle').click(function(){$('#orderCurrencyUAHToggle').addClass('activeCurrency');$('#orderCurrencyUSDToggle').removeClass('activeCurrency');$.each($('[data-uah]'),function(num,td){$(td).text($(td).attr('data-uah'));});setOrderSum();}).end().find('#orderCurrencyUSDToggle').click(function(){$('#orderCurrencyUSDToggle').addClass('activeCurrency');$('#orderCurrencyUAHToggle').removeClass('activeCurrency');$.each($('[data-uah]'),function(num,td){$(td).text((parseInt($(td).attr('data-uah'))/parseInt($('#usdSet').val())).toFixed(2));});setOrderSum();}).end();return html;}
function addRightTabContentTableHandler(html){html.find('.quantityInOrder').change(function(){var quantity=parseInt($(this).val()),productId=$(this).attr('data-product'),row=$(this).parents('.orderRow'),inPrice,outPrice,inSum,outSum,map;if(0>quantity){quantity=1;$(this).val(quantity);}
inPrice=parseFloat(row.find('.inputPriceInOrder').text());outPrice=parseFloat(row.find('.outputPriceInOrder').text());inSum=quantity*inPrice;outSum=quantity*outPrice;row.find('.inputSumInOrder').attr('data-uah',inSum.toFixed(2)).html(inSum.toFixed(2)).end().find('.outputSumInOrder').attr('data-uah',outSum.toFixed(2)).html(outSum.toFixed(2));map=JSON.stringify(getOrderMap());saveOrderMap(map,false);setOrderSum();}).end().find('#addNewSection').click(function(){var map,sectionsNames=[],sectionsNamesNumbers=[],biggestNumber=1;$.each($('.orderTableSectionName'),function(num,obj){sectionsNames.push($(obj).attr('name').split(' '));});$.each(sectionsNames,function(num,arr){if(parseInt(arr[1])){sectionsNamesNumbers.push(parseInt(arr[1]));}});if(sectionsNamesNumbers.length){biggestNumber=Math.max.apply(Math,sectionsNamesNumbers)+1;}
$('.withoutSectionInOrderTable').before('<tr class="orderTableSectionName" name="Раздел '+
biggestNumber+'"><th colspan="9"><span class="orderSectionName" contenteditable="true">Раздел '+biggestNumber+'</span></th></tr>');map=JSON.stringify(getOrderMap());saveOrderMap(map,true);}).end().find('#checkAllInMainOrder').click(function(){ORDER.checkAllInOrderDetails(true,'#orderHeadChecks input');}).end().find('#uncheckAllInMainOrder').click(function(){ORDER.checkAllInOrderDetails(false,'#orderHeadChecks input');}).end().find('.moveWithoutOrderUp').click(function(){saveOrderMap(JSON.stringify(swapRows(this,'out','up')),true);}).end().find('.moveWithoutOrderDown').click(function(){saveOrderMap(JSON.stringify(swapRows(this,'out','down')),true);}).end().find('.removeWithoutOrderRow').click(function(){removeRowFromOrder(this);}).end().find('.moveOrderUp').click(function(){saveOrderMap(JSON.stringify(swapRows(this,$(this).attr('data-section'),'up')),true);}).end().find('.moveOrderDown').click(function(){saveOrderMap(JSON.stringify(swapRows(this,$(this).attr('data-section'),'down')),true);}).end().find('.removeOrderRow').click(function(){removeRowFromOrder(this);}).end().find('.moveToCopyTo').click(function(){var action=$(this).closest('div').find('.moveToAction option:selected').val(),path=$(this).closest('div').find('.moveToPath option:selected').text(),productId=$(this).attr('name'),map=getOrderMap(),data={},quantity=1,currentPath=$(this).attr('data-section');if(!currentPath){currentPath='out';}
if('move'===action){quantity=$(this).closest('tr').find('.quantityInOrder').val();$.each(map[currentPath],function(num,obj){if(productId===_.keys(obj)[0]){map[currentPath].splice(num,1);}});}
data[productId]=quantity;map[path].push(data);saveOrderMap(JSON.stringify(map),true);}).end().find('.removeRowSection').click(function(){var map=getOrderMap();delete map[$(this).attr('name')];saveOrderMap(JSON.stringify(map),true);}).end().find('.orderSectionName').blur(function(){var currentSection=$(this).text(),sectionsNames=[];$.each($('.orderTableSectionName'),function(num,obj){sectionsNames.push($(obj).attr('name'));});if(-1===sectionsNames.indexOf($(this).text())){$(this).closest('tr').attr('name',currentSection);}
saveOrderMap(JSON.stringify(getOrderMap()),true);});return html;}
function addCategoriesTableHandler(html){html.filter('tr').mouseover(function(){var obj={pencilRemove:'triggerCategoryPencil',pencilAdd:'editCategoryPencil',removeRemove:'triggerRemoveCategory',removeAdd:'removeCategory'};kimEditOver(obj,this);}).mouseleave(function(){var obj={pencilRemove:'editCategoryPencil',pencilAdd:'triggerCategoryPencil',removeRemove:'removeCategory',removeAdd:'triggerRemoveCategory'};kimEditOver(obj,this);}).end().on('click','.removeCategory',function(){var catId=$(this).attr('name');CATEGORIES.removeCategory(catId);}).on('click','.editCategoryPencil',function(){$(this).attr('class','glyphicon glyphicon-floppy-disk saveEditCategory').css('margin-left','0');$(this).parents('tr').find('.categoryName').attr('contenteditable','true').css({'border':'1px solid hsl(195, 79%, 43%)','border-radius':'2px'});}).on('click','.saveEditCategory',function(){var id=$(this).attr('name'),name=VALIDATION.validateInputVal({val:$(this).parents('tr').find('.categoryName').text()}),self=this;if(name){CATEGORIES.editCategory(id,name,self);}});return html;}
function addKimTableHandler(html){html.filter('tr').mouseover(function(){var obj={pencilRemove:'triggerKimPencil',pencilAdd:'editKimPencil',removeRemove:'triggerRemoveKim',removeAdd:'removeKim'};kimEditOver(obj,this);}).mouseleave(function(){var obj={pencilRemove:'editKimPencil',pencilAdd:'triggerKimPencil',removeRemove:'removeKim',removeAdd:'triggerRemoveKim'};kimEditOver(obj,this);}).end().on('click','.removeKim',function(){var kimId=$(this).attr('name');KIM.removeKim(kimId);}).on('click','.editKimPencil',function(){$(this).attr('class','glyphicon glyphicon-floppy-disk saveEditKim').css('margin-left','0');$(this).parents('tr').find('.kimHardName, .kimName, .kimArticle').attr('contenteditable','true').css({'border':'1px solid hsl(195, 79%, 43%)','border-radius':'2px'});}).on('click','.saveEditKim',function(){var kimId=$(this).attr('name'),kim=VALIDATION.validateInputVal({val:$(this).parents('tr').find('.kimName').text(),digitsOnly:true}),kimHard=VALIDATION.validateInputVal({val:$(this).parents('tr').find('.kimHardName').text()}),self=this;if(kim&&kimHard){KIM.editKim(kimId,kim,kimHard,self);}});return html;}
function addMetallsTableHandler(html){html.filter('tr').mouseover(function(){var obj={pencilRemove:'triggerMetallPencil',pencilAdd:'editMetallPencil',removeRemove:'triggerRemoveMetall',removeAdd:'removeMetall'};kimEditOver(obj,this);}).mouseleave(function(){var obj={pencilRemove:'editMetallPencil',pencilAdd:'triggerMetallPencil',removeRemove:'removeMetall',removeAdd:'triggerRemoveMetall'};kimEditOver(obj,this);}).end().on('click','.editMetallPencil',function(){$(this).attr('class','glyphicon glyphicon-floppy-disk saveEditMetall').css('margin-left','0');$(this).parents('tr').find('.metallName, .metallPrice, .metallMass, .metallOutPrice').attr('contenteditable','true').css({'border':'1px solid hsl(195, 79%, 43%)','border-radius':'2px'});}).on('click','.saveEditMetall',function(){var scope=$(this).parents('tr');var metallName=VALIDATION.validateInputVal({val:scope.find('.metallName').text()}),metallPrice=VALIDATION.validateInputVal({val:scope.find('.metallPrice').text(),digitsOnly:true}),metallMass=VALIDATION.validateInputVal({val:scope.find('.metallMass').text(),digitsOnly:true}),metallOutPrice=VALIDATION.validateInputVal({val:scope.find('.metallOutPrice').text(),digitsOnly:true});if(metallName&&metallPrice&&metallMass&&metallOutPrice){METALLS.editMetall({metallId:$(this).attr('name'),metallName:metallName,metallPrice:metallPrice,metallMass:metallMass,metallOutPrice:metallOutPrice},this);}}).on('click','.removeMetall',function(){var metallId=$(this).attr('name');METALLS.removeMetall(metallId);});return html;}
function addMenuProductHandler(html){html.find('.openProductTab').click(function(){if(''===$(this).attr('data-selected')){$(this).addClass('openProductTabSelected').attr('data-selected','selected');}else if('selected'===$(this).attr('data-selected')){$(this).removeClass('openProductTabSelected').attr('data-selected','');}
enableDisableButton($('.openProductTabSelected'),$('#showItemFromFileManager'));}).end();return html;}
function addMenuOrdersHandler(html){html.find('.openProductTab').click(function(){if(''===$(this).attr('data-selected')){$(this).addClass('openProductTabSelected').attr('data-selected','selected');}else if('selected'===$(this).attr('data-selected')){$(this).removeClass('openProductTabSelected').attr('data-selected','');}
enableDisableButton($('.openProductTabSelected'),$('#showItemFromFileManager'));}).end().find('.consolidateOrder').click(function(){if(''===$(this).attr('data-selected')){$(this).addClass('consolidateOrderSelected').attr('data-selected','selected');}else if('selected'===$(this).attr('data-selected')){$(this).removeClass('consolidateOrderSelected').attr('data-selected','');}
enableDisableButton($('.consolidateOrderSelected'),$('#FMconsolidatedOrdersBtn'));}).end();return html;}
Dima.prototype={tabs:{openProductCreation:function(){if(!MAIN.prRequested){TABS.getLeftTabsList();TABS.getRightTabsList();}},getLeftTabsList:function(){$.ajax({url:URL_TABS+'getLeftTabsList',method:'GET'}).then(function(data)
{var html;MAIN.tabsList=data.tabsList;MAIN.tableContent=data.kim;MAIN.prRequested=true;if(data.html){html=$(data.html);addLeftTabsHandler(html);html.insertBefore('#addNewTab');}
if(data.active&&data.html){TABS.getLeftTabContent(data.productId,data.active);}else{$('#myTab, #leftTabsContent').fadeIn('slow');setTimeout(function(){spinnerLeft.stop(document.getElementById('leftTabsSpinner'));},200);TABS.showPreferences();MENU.createFileManager('PR');}
$(function(){$('[data-toggle="tooltip"]').tooltip();});});},getLeftTabContent:function(productId,tabId){localStorage.currentCaretPos=0;$.ajax({url:URL_TABS+'getLeftTabContent/'+productId,method:'GET'}).then(function(data)
{var kim,metall,metallOut;$('#dbProductsListList').removeClass('active');$('.currentTab').attr('id',tabId).removeClass('saveInDB addedToOrder').addClass('active '+data.css).html(addLeftTabContentHandler($(data.html)));$('.removeRow').hide();MAIN.curTabId=tabId;MAIN.curTabName='a[href="#'+MAIN.curTabId+'"] .tabName';MAIN.productId=productId;MAIN.detailsForArticle=data.detailsForArticle;MAIN.isArticle=data.article;MAIN.metallId=data.metallId;if(!data.article){kim=$('.listOfKim option:selected').attr('kim');metall=$('.listOfMetalls option:selected').attr('metall');metallOut=$('.listOfMetalls option:selected').attr('metallOut');$('[data-cell="KIM1"]').val(kim);$('[data-cell="PR1"]').val(metall);$('[data-cell="PR2"]').val(metallOut);}else{$('.rowValueInput').removeClass('rowValueInput');$('.cellBind').removeClass('cellBind');$('.glyphicon-retweet').removeClass('glyphicon-retweet');$('.removeFormula, .editFormula').remove();$('#metallHistorySelect option:last-child').prop('selected',true);recalculateArticleTable();}
$.each($('.bindFormulaWithCell'),function(num,obj){var li=$(obj).closest('li');li.find('.addAvailableCellList').html(PRODUCT.addAvailableCellList(li.find('.formulaValue').text()));});$('#calx').calx();showBody();if(localStorage.addToOrder){ORDER.addToOrder();delete localStorage.addToOrder;delete localStorage.alwaysInTable;}
$(function(){$('[data-toggle="tooltip"]').tooltip();});$('#myTab, #leftTabsContent').fadeIn('slow');setTimeout(function(){spinnerLeft.stop(document.getElementById('leftTabsSpinner'));},200);});},changeActiveTab:function(id,tabId,action){$.ajax({url:URL_TABS+action,method:'POST',data:{id:id,tabId:tabId}}).then(function(data)
{});},closeLeftTab:function(idDb,currentID){var nextActiveTab=MAIN.curTabId,productId=MAIN.productId,elemInObj=Object.keys(MAIN.tabsList),ifActive,index;if(2===elemInObj.length){nextActiveTab='dbProductsListTab';}else{ifActive=MAIN.tabsList[currentID].active;if('1'===ifActive){index=elemInObj.indexOf(currentID);if(index===elemInObj.length-1){nextActiveTab=Object.keys(MAIN.tabsList)[elemInObj.length-2];}else{nextActiveTab=Object.keys(MAIN.tabsList)[index+1];}
productId=MAIN.tabsList[nextActiveTab].productId;MAIN.tabsList[nextActiveTab].active='1';}}
delete MAIN.tabsList[currentID];$('[aria-controls='+currentID+']').hide('highlight');setTimeout(function(){$('[aria-controls='+currentID+']').parent().remove();},900);if('dbProductsListTab'===nextActiveTab||undefined===nextActiveTab){$('.currentTab').removeClass('active');$('#dbProductsListTab, #dbProductsListList').addClass('active');TABS.loadPreferences();MENU.createFileManager('PR');}else{$('[aria-controls='+nextActiveTab+']').parent().addClass('active');}
$.ajax({url:URL_TABS+'closeTab',method:'POST',data:{id:idDb,tabId:currentID,nextActiveTab:nextActiveTab}}).then(function()
{if('dbProductsListTab'!==nextActiveTab){TABS.getLeftTabContent(productId,nextActiveTab);}});},closeRightTab:function(tabId,orderID){var nextActiveTab=MAIN.curTabRightId,productId=MAIN.orderId,elemInObj=Object.keys(MAIN.tabsRightList),orderId='or'+tabId,ifActive,index;if(2===elemInObj.length){nextActiveTab='fileManagerOrdersTab';delete MAIN.orderId;}else{ifActive=MAIN.tabsRightList[orderId].active;if('1'===ifActive){index=elemInObj.indexOf(orderId);if(index===elemInObj.length-1){nextActiveTab=Object.keys(MAIN.tabsRightList)[elemInObj.length-2];}else{nextActiveTab=Object.keys(MAIN.tabsRightList)[index+1];}
productId=MAIN.tabsRightList[nextActiveTab].orderId;MAIN.tabsRightList[nextActiveTab].active='1';}}
delete MAIN.tabsRightList[orderId];$('[aria-controls='+orderId+']').hide('highlight');setTimeout(function(){$('[aria-controls='+orderId+']').parent().remove();},700);if('fileManagerOrdersTab'===nextActiveTab||undefined===nextActiveTab){$('.currentTabRight').removeClass('active');$('#fileManagerOrdersTab, #fileManagerOrdersWrapper').addClass('active');$('#livemill').prop('muted',false);}else{$('[aria-controls='+nextActiveTab+']').parent().addClass('active');}
if('fileManagerOrdersTab'!==nextActiveTab){nextActiveTab=VALIDATION.digitsOnly(nextActiveTab);}
$.ajax({url:URL_TABS+'closeRightTab',method:'POST',data:{tabId:tabId,orderID:orderID,nextActiveTab:nextActiveTab}}).then(function()
{if('fileManagerOrdersTab'!==nextActiveTab){TABS.getRightTabContentOrderDetails(productId,'or'+nextActiveTab);TABS.getRightTabContentTable(productId);}});},getLastLeftTab:function(){$.ajax({url:URL_TABS+'getLastLeftTab',method:'GET'}).then(function(data)
{TABS.addNewLeftTab(data);});},addNewLeftTab:function(id){$.ajax({url:URL_TABS+'addNewLeftTab/'+id,method:'POST'}).then(function(data)
{window.location.href=LOCATION;});},changeTabName:function(obj){$.ajax({url:URL_TABS+'changeTabName',method:'POST',data:{prId:MAIN.productId,prName:obj.prName,categoryId:obj.categoryId,kimId:obj.kimId,metallId:obj.metallId}}).then(function(data)
{});},openSavedProduct:function(arr,tab,active,refresh){var refresh=(refresh===undefined)?refresh=true:refresh;$.ajax({url:URL_TABS+'openSavedProduct',method:'POST',data:{arr:arr,tab:tab,active:active}}).then(function(data)
{console.log(data);if(true===data&&refresh){window.location.href=LOCATION;}});},getRightTabsList:function(){$.ajax({url:URL_TABS+'getRightTabsList',method:'GET'}).then(function(data)
{if(!data.tabs){$('#rightTabs, #rightTabsContent').fadeIn('slow');CLIENTS.getClientsTree();setTimeout(function(){spinnerRight.stop(document.getElementById('orderSpinner'));},200);$('#livemill').prop('muted',false);return true;}
$(addRightTabsHandler($(data.html))).insertBefore('#addNewTabRight');MAIN.tabsRightList=data.obj;if('fileManagerOrdersTab'!==data.tabId){TABS.getRightTabContentOrderDetails(data.orderId,data.tabId);TABS.getRightTabContentTable(data.orderId);MAIN.orRequested=true;return true;}
MAIN.tabsRightList.fileManagerOrdersTab.active='1';MAIN.curTabRightId='fileManagerOrdersTab';console.log(MAIN);$('#rightTabs, #rightTabsContent').fadeIn('slow');$('#livemill').prop('muted',false);setTimeout(function(){spinnerRight.stop(document.getElementById('orderSpinner'));},200);$(function(){$('[data-toggle="tooltip"]').tooltip();});});},getRightTabContentOrderDetails:function(orderId,tabId){$.ajax({url:URL_TABS+'getRightTabContentOrderDetails/',method:'GET',data:{orderId:orderId}}).then(function(data)
{if(true===data.success){$('#fileManagerOrdersWrapper, #fileManagerOrdersTab').removeClass('active');$('#livemill').prop('muted',true);$('.currentTabRight').attr('id',tabId).addClass('active');$('#orderDetailsWrapper').html(addRightTabContentOrderHandler($(data.html)));MAIN.curTabRightId=tabId;MAIN.curTabRightName='a[href="#'+MAIN.curTabRightId+'"] .tabName';MAIN.orderId=orderId;if('TRUE'===data.consolidate){store.set('consOrder','consAverageTr');}else{store.remove('consOrder');}
$(function(){$('[data-toggle="tooltip"]').tooltip();$.each(data.orderDescription,function(name,arr){$('[data-orderdetails="'+name.replace(/%/g,'')+'"]').autocomplete({source:arr,select:function(event,ui){$('[data-orderdetails="'+name.replace(/%/g,'')+'"]').attr('value',ui.item.value).val(ui.item.value);var obj=ORDER.createJSONFromOrderDescription();ORDER.changeOrderDetails({orderId:MAIN.orderId,orderDescr:obj});}});});});return this;}
log(data.error);});},getRightTabContentTable:function(orderId){$.ajax({url:URL_TABS+'getRightTabContentTable/',method:'GET',data:{orderId:orderId}}).then(function(data)
{if(data.success){$('#orderTableWrapper').html(addRightTabContentTableHandler($(data.html)));if(data.consolidateData){$('#saveOrderInDBWrapper').hide();$('#consOrderButtonsWrapper').show();buildConsolidateOrder(data.consolidateData);}
setOrderSum();showBody();$('#rightTabs, #rightTabsContent').fadeIn('slow');setTimeout(function(){spinnerRight.stop(document.getElementById('orderSpinner'));},200);$(function(){$('[data-toggle="tooltip"]').tooltip({my:"left+15 center",at:"right center"});$('#orderTable').resizableColumns({});});}});},showKim:function(){$.when(CATEGORIES.getCategoriesTable(),KIM.getKIMTable(),METALLS.getMetallsTable()).done(function(){setTimeout(function(){spinnerKim.stop(document.getElementById('orderSpinner'));},500);});},loadPreferences:function(){$.each(MAIN.tabsList,function(tabId,obj){obj.active='0';});MAIN.tabsList.dbProductsListTab.active='1';MAIN.curTabId='dbProductsListTab';},setActiveDefaultTab:function(tabsList,id,curTabId){$.each(MAIN[tabsList],function(tabId,obj){obj.active='0';});MAIN[tabsList][id].active='1';MAIN[curTabId]=id;},showPreferences:function(){$('#dbProductsListTab, #dbProductsListList').addClass('active');TABS.loadPreferences();showBody();},splitMonitor:function(){$('#left-component').css('width',localStorage.split);$('#divider, #right-component').css('left',localStorage.split);$('#db-left-component').css('width',localStorage['db-split']);$('#db-divider, #db-right-component').css('left',localStorage['db-split']);}},product:{saveProductInDB:function(){$.ajax({url:URL_PRODUCT+'saveProductInDB',method:'POST',data:{prId:MAIN.productId}}).then(function(data)
{data?$('#statusOfProductInDB').html('Сохранено в базе данных'):false;});},saveArticleOfProduct:function(article){$.ajax({url:URL_PRODUCT+'saveArticleOfProduct',method:'POST',data:{prId:MAIN.productId,article:article}}).then(function(data)
{if(true===data.status){$('.checkToArticle, #cancelArticleBtn, #saveArticle').remove();PRODUCT.saveProductInDB();TABS.getLeftTabContent(MAIN.productId,MAIN.curTabId);}else if('already'===data.status){var href='';if(!MAIN.tabsList[MAIN.curTabId]){href=$('<span><a id="errorOpenInCurrentTab"> Открыть в текущей вкладке</a><span> или</span><a id="errorOpenInNewTab"> Открыть в новой вкладке</a></span>');href.find('#errorOpenInCurrentTab').click(function(){console.log(MAIN);TABS.openSavedProduct(data.id,MAIN.curTabId,true,true);}).end().find('#errorOpenInNewTab').click(function(){TABS.openSavedProduct(data.id,'new',true,true);});}else{href=' Продукт открыт во вкладках.';}
$('#errorArticle').html(ERR.ARTICLE.already).append(href).show();}});},saveTable:function(){$.ajax({url:URL_PRODUCT+'changeTableContent',method:'POST',data:{prId:MAIN.productId,tableContent:JSON.stringify(PRODUCT.getTableContent('#sortable li')),alwaysInTable:JSON.stringify(PRODUCT.getTableContent('#alwaysInTable li'))}}).then(function(data)
{});},getTableContent:function(dom){var tableContent={},i=0,temp;$.each($(dom),function(key,val){temp=_.clone(tempTable);if(''!==$('.rowNumber',val).text()){temp['%ROW_NUMBER%']=$('.rowNumber',val).text();temp['%ROW_NAME%']=$('.rowNameInput',val).val();temp['%DATA_CELL%']=$('.rowValueInput',val).attr('data-cell');temp['%DATA_FORMULA%']=$('.rowValueInput',val).attr('data-formula');temp['%INPUT_VALUE%']=$('.rowValueInput',val).val();tableContent[i]=temp;i++;}});return tableContent;},createTable:function(tableContent,alwaysInTable){$.ajax({url:URL_PRODUCT+'createTable',method:'POST',data:{prId:MAIN.productId,tableContent:JSON.stringify(tableContent),alwaysInTable:JSON.stringify(alwaysInTable)}}).then(function(data)
{$('#sortable').html(data[0]);$('#alwaysInTable').html(data[1]);$('.removeRow').hide();PREFERENCES.applyCss();});},catchKey:function(el,mathAction,step){var thisVal=Number($(el).val());if('+'===mathAction){$(el).val((thisVal+step).toFixed(2)).attr('value',(thisVal+step).toFixed(2));}else{$(el).val((thisVal-step).toFixed(2)).attr('value',(thisVal-step).toFixed(2));}
$('#calx').calx();PRODUCT.saveTable();},addNewFormula:function(formulas,binding){$.ajax({url:URL_PRODUCT+'addNewFormula',method:'POST',data:{formulas:formulas,prId:MAIN.productId}}).then(function(data)
{if(true===binding){PRODUCT.saveTable();$('#formulasList').html(addLeftTabContentHandler($(data.formulasList)));$.each($('.bindFormulaWithCell'),function(num,obj){var li=$(obj).closest('li');li.find('.addAvailableCellList').html(PRODUCT.addAvailableCellList(li.find('.formulaValue').text()));});$('#calx').calx();}});},removeBindingFormulaFromTable:function(scope,bindCell){$('.rowValueInput[data-cell='+bindCell+']').removeAttr('color').val('').attr('value','').attr('data-formula','').css('color','');$('.rowValueInput[data-cell='+bindCell+']').parent().parent().find('.rowNameInput').css('color','');$('.rowValueInput[data-cell='+bindCell+']').parent().parent().css({'background':'','color':''});if(scope){$(scope).parent().removeClass('list-group-item-info');$(scope).remove();}
$('#calx').calx();},getFormulasList:function(){var formulasList={},formula,cell;$.each($('.formula'),function(key,val){formula=$('.formulaValue',val).text();cell=$.trim($('.cellBind',val).text());formulasList[key]={formula:formula,cell:cell};});return JSON.stringify(formulasList);},toggleAddFormula:function(){''!==$('#addFormulaInputPr').val()?$('#addFormulaBtnPr').slideDown():$('#addFormulaBtnPr').slideUp();},cancelInputFormula:function(){clickOnFormulaInput=false;$('#addFormulaInputPr').css('border-color','').val('');$('.formulaBtnGroupPr').hide('drop');$('.currentTab ').removeAttr('tabindex').unbind('keydown keypress keyup click');$('body').off('keypress').off('click','.rowNumber').css('cursor','auto');$(document).keydown(function(e){if(e.which===8){return true;}});$('#formulasHelper').hide('slide');},addElementToFormulaInput:function(scope){PRODUCT.addWhereCaret(localStorage.currentCaretPos,$(scope).text());localStorage.currentCaretPos=parseInt(localStorage.currentCaretPos)+parseInt($(scope).text().length);PRODUCT.toggleAddFormula();},addBtnToFormulasHelper:function(newFl){$.ajax({url:URL_PRODUCT+'addBtnToFormulasHelper',method:'POST',data:{'newFl':newFl}}).then(function(data)
{if(true===data){$('<span class="justCreated"><button type="button" class="btn custom-addRowsToTable btn-xs fhBtn">'+newFl+''+'<span class="glyphicon glyphicon-remove removeFhBtn" aria-hidden="true"></span></button></span>').insertBefore('#addNewBtnSpan');$('.justCreated').find('.removeFhBtn').hide('fast');$('.justCreated').show('slow').removeClass('.justCreated');$('#addNewFhBtnInput').val('');}});},removeFormulasHelper:function(dom,fhText){$.ajax({url:URL_PRODUCT+'removeBtnFromFormulasHelper',method:'POST',data:{'fhText':fhText}}).then(function(data)
{$(dom).parent().fadeOut('slow');});},addAvailableCellList:function(formula){var res='<select><option val="false">Выберите ячейку</option>';$.each($('.rowValueInput'),function(num,obj){var cell=$(obj).attr('data-cell'),dataFormula=$(obj).attr('data-formula');if(-1===formula.search(cell)&&-1===notIncludeInCell.indexOf(cell)&&!dataFormula&&PRODUCT.checkInputOnFormula(formula,cell)){res+='<option val="true">'+cell+'</option>';}});res+='</select>';return res;},checkInputOnFormula:function(formula,cell){var tableContent=PRODUCT.getTableContent('#sortable li'),alwaysInTable=PRODUCT.getTableContent('#alwaysInTable li'),cellsArr={},cellsInFormula=[],res=true;$.each(tableContent,function(key,val){cellsArr[val['%DATA_CELL%']]=val['%DATA_FORMULA%'];});$.each(alwaysInTable,function(key,val){cellsArr[val['%DATA_CELL%']]=val['%DATA_FORMULA%'];});$.each(cellsArr,function(key){if(-1!==formula.search(key)){cellsInFormula.push(key);}});$.each(cellsInFormula,function(key,val){if(-1!==cellsArr[val].search(cell)){res=false;}});return res;},addWhereCaret:function(caretPos,what){var currentVal=$('#addFormulaInputPr').val();$('#addFormulaInputPr').val(currentVal.substring(0,caretPos)+what+currentVal.substring(caretPos));},removeChar:function(string,index){var res='';for(var i in string){(index!==Number(i))?res=res+string[i]:1;}
return res;},getProductsTree:function(){$.ajax({url:URL_PRODUCT+'getProductsTree',method:'GET'}).then(function(data)
{var tree=$('#productsTree');tree.tree({data:data,autoOpen:true,dragAndDrop:false});tree.bind('tree.select',function(event){if(event.node){var node=event.node;if(node.id){$.ajax({url:URL_TABS+'getLeftTabContent/'+node.id,method:'GET',data:{sector:true}}).then(function(data){MAIN.productId=node.id;$('#completedProduct').html(addLeftTabContentHandler($(data.html)));$('.rowValueInput').removeClass('rowValueInput');$('.cellBind').removeClass('cellBind');$('.glyphicon-retweet').removeClass('glyphicon-retweet');$('.removeFormula, .editFormula').remove();$('#metallHistorySelect option:last-child').prop('selected',true);});}}
else{}});});},getClientsDetails:function(){$.ajax({url:URL_MENU+'getClientsDescriptionObj',method:'GET'}).then(function(data)
{if(data){$(function(){$('[data-toggle="tooltip"]').tooltip();$.each(data,function(name,arr){$('#addNewClientForm input, #addNewProjectForm input').filter('[name="'+name+'"]').autocomplete({source:arr,select:function(event,ui){$('#addNewClientForm input, #addNewProjectForm input').filter('[name="'+name+'"]').attr('value',ui.item.value).val(ui.item.value);}});});});}});}},order:{createNewOrder:function(project,refresh,consolidate){var refresh=(refresh===undefined)?refresh=true:refresh;var consolidate=(consolidate===undefined)?consolidate=false:consolidate;return $.ajax({url:URL_ORDER+'createNewOrder',method:'POST',data:{project:project,consolidate:consolidate}}).then(function(data)
{if(false!==data&&refresh){window.location.href=LOCATION;}
return data;});},addToOrder:function(){var map,productId=MAIN.productId,alwaysInTable='',obj={};if(localStorage.addToOrder){alwaysInTable=localStorage.alwaysInTable;}else{$('.rowValue input').addClass('rowValueInput');alwaysInTable=JSON.stringify(PRODUCT.getTableContent('#alwaysInTable li'));$('.rowValueInput').removeClass('rowValueInput');}console.log(alwaysInTable);$.ajax({url:URL_ORDER+'addProductToOrder',method:'POST',data:{orderId:MAIN.orderId,productId:productId,alwaysInTable:alwaysInTable}}).then(function(data)
{if('ok'===data.status){map=getOrderMap();obj[productId]=1;map.out.push(obj);saveOrderMap(JSON.stringify(map),true);}});},addToConsolidateOrder:function(orderId,arr){return $.ajax({url:URL_ORDER+'addToConsolidateOrder',method:'POST',data:{orderId:orderId,arr:arr}}).then(function(data)
{window.location.href=LOCATION;});},saveOrderInDB:function(){$.ajax({url:URL_ORDER+'saveOrderInDB',method:'POST',data:{orderId:MAIN.orderId}}).then(function(data)
{if(data){$('#saveOrderInDBWrapper').html('Сохранено в базе данных');}});},checkAllInOrderDetails:function(param,id){var id=(id===undefined)?id='#orderDetails input':id;$.each($(id),function(key,val){$(val).prop('checked',param);});},changeDiscount:function(obj){$.ajax({url:URL_ORDER+'changeDiscount',method:'POST',data:obj}).then(function(data){console.log(data);});},changeOrderDetails:function(obj){$.ajax({url:URL_ORDER+'changeOrderDetails',method:'POST',data:obj}).then(function(data){});},removeFromOrder:function(productId){$.ajax({url:URL_ORDER+'removeFromOrder',method:'POST',data:{orderId:MAIN.orderId,productId:productId}}).then(function(data){});},openSavedOrder:function(arr,tab,active,refresh){var refresh=(refresh===undefined)?refresh=true:refresh;$.ajax({url:URL_ORDER+'openSavedOrder',method:'POST',data:{arr:arr,tab:tab,active:active}}).then(function(data){if(true===data&&refresh){window.location.href=LOCATION;}});},createJSONFromOrderDescription:function(){var obj=_.clone(orderPlaceholder),arr=_.keys(obj),i=0;$.each($('.inputOrderDetails'),function(key,val){if(!$(val).hasClass('skip')){obj[arr[i]]=$(val).val();i++;}});obj["%ESTIMATE%"]=$('#orderEstimateInput').val();obj["%DATE%"]=$('#orderDateInput').val();return obj;}},categories:{addCategory:function(categoryName,article){$.ajax({url:URL_CATEG+'add',method:'POST',data:{categoryName:categoryName,article:article}}).then(function(data)
{if(true===data){$('#addCategoryInput, #addCategoryArticleInput').val('');CATEGORIES.getCategoriesTable();CATEGORIES.getCategoriesList();}});},getCategoriesTable:function(){return $.ajax({url:URL_CATEG+'getCategoriesTable',method:'GET'}).then(function(data)
{MAIN.categoriesTableContent=data.categoriesTableContent;$('#categoriesListTable tbody').html(addCategoriesTableHandler($(data.html)));});},getCategoriesList:function(){return $.ajax({url:URL_CATEG+'getCategoriesList',method:'GET',data:{prId:MAIN.productId}}).then(function(data){console.log(data);$('.listOfCategories').html(data.html);});},editCategory:function(id,name,save){cancelArticleBtn();$.ajax({url:URL_CATEG+'editCategory',method:'POST',data:{id:id,name:name}}).then(function(data)
{if(true===data){CATEGORIES.getCategoriesTable();CATEGORIES.getCategoriesList();}else{$(save).parents('tr').find('.categoryName').css({'border':'3px solid hsl(0, 69%, 22%)','border-radius':'2px'});}});},removeCategory:function(id){cancelArticleBtn();$.ajax({url:URL_CATEG+'removeCategory',method:'POST',data:{id:id}}).then(function(data)
{if(true===data){CATEGORIES.getCategoriesTable();CATEGORIES.getCategoriesList();}});}},kim:{getKIMTable:function(){return $.ajax({url:URL_KIM+'getKIMTable',method:'GET'}).then(function(data)
{MAIN.fileManagerOrdersWrapperleContent=data.fileManagerOrdersWrapperleContent;$('#tbodyKIM').html(addKimTableHandler($(data.html)));});},getKimList:function(){$.ajax({url:URL_KIM+'getKimList',method:'GET',data:{prId:MAIN.productId}}).then(function(data){$('.listOfKim').html(data.html);var kim=$('.listOfKim option:selected').attr('kim');$('[data-cell="KIM1"]').val(kim);$('#calx').calx();});},addKIMtoTable:function(kim,kimHard){cancelArticleBtn();$.ajax({url:URL_KIM+'addKIMtoTable',method:'POST',data:{kim:kim,kimHard:kimHard}}).then(function(data)
{if(true===data){$('#kimInput, #kimHardInput, #kimArticle').val('');KIM.getKIMTable();KIM.getKimList();}else{}});},editKim:function(kimId,kim,kimHard,save){cancelArticleBtn();$.ajax({url:URL_KIM+'editKim',method:'POST',data:{kimId:kimId,kim:kim,kimHard:kimHard}}).then(function(data)
{if(true===data){KIM.getKIMTable();KIM.getKimList();}else{$(save).parents('tr').find('.kimHardName, .kimName').css({'border':'3px solid hsl(0, 69%, 22%)','border-radius':'2px'});}});},removeKim:function(kimId){cancelArticleBtn();$.ajax({url:URL_KIM+'removeKim',method:'POST',data:{kimId:kimId}}).then(function(data)
{if(true===data){KIM.getKIMTable();KIM.getKimList();}});}},metalls:{getMetallsTable:function(){return $.ajax({url:URL_METALLS+'getMetallsTable',method:'GET'}).then(function(data){MAIN.metallTableContent=data.metallTableContent;$('#tbodyMetalls').html(addMetallsTableHandler($(data.html)));});},editMetall:function(obj,scope){cancelArticleBtn();$.ajax({url:URL_METALLS+'editMetall',method:'POST',data:obj}).then(function(data)
{if(true===data){METALLS.getMetallsTable();METALLS.getMetallsList();}else{$(scope).parents('tr').find('.metallName, .metallPrice, .metallMass, .metallOutPrice').css({'border':'3px solid hsl(0, 69%, 22%)','border-radius':'2px'});}
if(MAIN.isArticle&&(obj.metallId===MAIN.metallId)){TABS.getLeftTabContent(MAIN.productId,MAIN.curTabId);}});},getMetallsList:function(){$.ajax({url:URL_METALLS+'getMetallsList',method:'GET',data:{prId:MAIN.productId}}).then(function(data){$('.listOfMetalls').html(data.html);var metall=$('.listOfMetalls option:selected').attr('metall');var metallOut=$('.listOfMetalls option:selected').attr('metallOut');$('[data-cell="PR1"]').val(metall);$('[data-cell="PR2"]').val(metallOut);$('#calx').calx();});},addMetallToTable:function(obj){cancelArticleBtn();$.ajax({url:URL_METALLS+'addMetallToTable',method:'POST',data:obj}).then(function(data)
{if(true===data){$('#metallName, #metallPrice, #metallMass, #metallOutPrice, #metallArticle').val('');METALLS.getMetallsTable();METALLS.getMetallsList();}});},removeMetall:function(metallId){cancelArticleBtn();$.ajax({url:URL_METALLS+'removeMetall',method:'POST',data:{metallId:metallId}}).then(function(data)
{console.log(data);if(true===data){METALLS.getMetallsTable();METALLS.getMetallsList();}});}},menu:{showMainMenu:function(){$('#livemill').prop('muted',true);MENU.activeClassValidation({id:'#backIcon',class:'activeTopIcon',extraClass:'hvr-pulse-grow',scope:'#menuIconsTop div'});localStorage.siteSector='MENU';showBody();$('#topIconsWrapper, #creatingProductsWrapper, #preferencesWrapper, #menuIconsRight, #menuIconsBottom, #menuIconsLeft').hide();$('#mainMenuWrapper').fadeIn();},runPreferences:function(){$('#livemill').prop('muted',true);if(MENU.activeClassValidation({id:'#prefIcon',class:'activeTopIcon',extraClass:'hvr-pulse-grow',scope:'#menuIconsTop div'})){localStorage.siteSector='PR';showBody();$('#mainMenuWrapper, #databaseWrapper, #creatingProductsWrapper').hide();$('#topIconsWrapper, #preferencesWrapper').show();}},runDB:function(){$('#livemill').prop('muted',true);if(MENU.activeClassValidation({id:'#dbIcon',class:'activeTopIcon',extraClass:'hvr-pulse-grow',scope:'#menuIconsTop div'})){localStorage.siteSector='DB';showBody();$('#mainMenuWrapper, #preferencesWrapper, #creatingProductsWrapper').hide();$.when(TABS.showKim()).done(function(){setTimeout(function(){spinnerKim.stop(document.getElementById('orderSpinner'));},300);});$('#topIconsWrapper, #databaseWrapper').show();if(!MAIN.prRequested){TABS.getLeftTabsList();}}},runProductCreation:function(){if($('#fileManagerOrdersWrapper').hasClass('active')){}
if(MENU.activeClassValidation({id:'#prIcon',class:'activeTopIcon',extraClass:'hvr-pulse-grow',scope:'#menuIconsTop div'})){localStorage.siteSector='OR';showBody();$('#mainMenuWrapper, #preferencesWrapper, #databaseWrapper').hide();$('#topIconsWrapper, #creatingProductsWrapper').show();if(!MAIN.orRequested){TABS.getRightTabsList();PRODUCT.getClientsDetails();}
PRODUCT.getProductsTree();}},showTopIcons:function(px,animate,timeout){setTimeout(function(){$('#backIcon, #prefIcon, #dbIcon, #menuOpen, #prIcon').blur().animate({"marginTop":px},animate);},timeout);},activeClassValidation:function(obj){if(!$(obj.id).hasClass(obj.class)){$(obj.scope).removeClass(obj.class).addClass(obj.extraClass);$(obj.id).addClass(obj.class).removeClass(obj.extraClass);return true;}
return false;},onHoverElement:function(obj){var scope=obj.scope,css=obj.css,speed=obj.speed;$(scope).stop(true).delay(20).animate(css,speed);},createFileManager:function(param){$.ajax({url:URL_MENU+'createFileManager',method:'GET',data:{param:param}}).then(function(data)
{$('#fileManagerCatogoriesSelect').html(data.categories);$('#fileManagerProductsTable').html(addMenuProductHandler($(data.products)));$('#fileManagerOrdersTable').html(addMenuOrdersHandler($(data.orders)));});},searchInTable:function(rows,text,elem){if(!text){rows.show();}else{rows.hide();$.each(rows,function(num,tr){$.each($(tr),function(key,td){if(-1!==$(td).text().toLowerCase().search(text.toLowerCase())){$(td).closest(elem).show();return true;}});});}},searchInTree:function(node,text){var res=false;$.each(node,function(num,obj){if(!res){$.each(obj.info,function(key,val){if(-1!==val.toLowerCase().search(text)&&!res){res=true;}else if(obj.children&&obj.children.length){res=MENU.searchInTree(obj.children,text);}
if(res){$('#clientsTree li .jqtree-title:contains("'+obj.name+'")').closest('.clientInTree').show();}});}});},getPreferencesSettings:function(){return preferencesSettings;},fillFormOfClientsInfo:function(info){$('#addNewProjectForm, .addNewClientBtnsWrapper').hide();if(info){$.each($('#addNewClientForm input'),function(num,input){var $input=$(input);$input.val(info[$input.attr('name')]);});$('#h3NewClientInfo').hide();$('#h3ClientInfo').show();$('#addNewClientBtn').hide();$('.addNewClientBtnsWrapper').show();}else{$('#addNewClientForm input').val('');$('#h3NewClientInfo').show();$('#h3ClientInfo').hide();$('#addNewClientBtn').show();$('.addNewClientBtnsWrapper').hide();}
$('#addNewClientForm').show();},fillFormOfProjectInfo:function(info){$('#addNewClientForm, .addNewProjectBtnsWrapper').hide();if(info){$.each($('#addNewProjectForm input'),function(num,input){var $input=$(input);$input.val(info[$input.attr('name')]);});$('#h3NewProjectInfo').hide();$('#h3ProjectInfo').show();$('#addNewProjectBtn').hide();$('.addNewProjectBtnsWrapper').show();}else{$('#addNewProjectForm input').val('');$('#h3NewProjectInfo').show();$('#h3ProjectInfo').hide();$('#addNewProjectBtn').show();$('.addNewProjectBtnsWrapper').hide();}
$('#addNewProjectForm').show();}},preferences:{insertFontSizes:function(arr,elem){var i=1;var option='';for(i;i<=60;i++){option+=$(elem).css('font-size')===i+'px'?'<option selected>':'<option>';option+=i+'px</option>';}
$.each(arr,function(num,target){$(target).append(option);});},applyCss:function(){if(localStorage.customCSS){try{$.each(JSON.parse(localStorage.customCSS),function(elem,obj){$.each(obj,function(key,val){$(elem).css(key,val);});});PREFERENCES.applyPreferences(MENU.getPreferencesSettings());}catch(err){console.log(err);}}},applyPreferences:function(arr){$.each(arr,function(num,obj){$(obj.id).css({backgroundColor:$(obj.elem).css(obj.style)}).colorpicker({color:$(obj.elem).css(obj.style),backgroundColor:$(obj.elem).css(obj.style)}).on('changeColor',function(ev){$(obj.id).css('backgroundColor',ev.color.toHex());PREFERENCES.applyColorAndSaveToLS(obj.cssArr,obj.style,ev,obj.important);});});},applyColorAndSaveToLS:function(cssArr,style,ev,important){var imp='';if(important&&undefined!==important){imp=' !important';}
$(cssArr.join(', ')).css(style,ev.color.toHex());for(var i=0;i<cssArr.length;i++){var css=PREFERENCES.checkStorageCSS(cssArr[i]);css[cssArr[i]][style]=ev.color.toHex()+imp;THEMES.addThemeCss(css);}},checkStorageCSS:function(elem){if(!localStorage.customCSS){localStorage.customCSS=JSON.stringify({});}
var css=JSON.parse(localStorage.customCSS);if(!css[elem]){css[elem]={};localStorage.customCSS=JSON.stringify(css);}
return JSON.parse(localStorage.customCSS);}},validation:{validateInputVal:function(obj){var val=obj.val.trim();if(val&&obj.digitsOnly){val=VALIDATION.digitsOnly(val);}
if(val&&obj.unique){val=VALIDATION.onUnique(val,obj.id);}
if(!val){if(obj.id){VALIDATION.showError(obj.id);}
return false;}
return val;},digitsOnly:function(val){var res;res=val.replace(/[A-Za-z]+/g,'').replace(/,/g,'.');return res;},onUnique:function(val,id){var articles,names;switch(id){case'#metallName':names=MAIN.metallTableContent.names;if(0<names.length){val=VALIDATION.parseArray(names,val);}
break;case'#metallArticle':articles=MAIN.metallTableContent.articles;if(0<articles.length){val=VALIDATION.parseArray(articles,val);}
break;case'#addCategoryInput':names=MAIN.categoriesTableContent.names;if(0<names.length){val=VALIDATION.parseArray(names,val);}
break;case'#addCategoryArticleInput':articles=MAIN.categoriesTableContent.articles;console.log(MAIN);if(0<articles.length){val=VALIDATION.parseArray(articles,val);}
break;}
return val;},showError:function(id){$(id).addClass('inputError');setTimeout(function(){$(id).removeClass('inputError');},1000);},parseArray:function(arr,val){var i;for(i=0;i<arr.length;i++){if(val.toLowerCase()===arr[i].toLowerCase()){val=false;break;}}
return val;}},clients:{getClientsTree:function(refresh){$.ajax({url:URL_CLIENTS+'getClientsTree',method:'GET'}).then(function(data)
{currentClietsTree=data.tree;var tree=$('#clientsTree');if(refresh){tree.tree('loadData',data.tree);}else{tree.tree({data:data.tree,autoOpen:true,dragAndDrop:false,saveState:true,saveState:'clients-Tree',openedIcon:$('<span class="glyphicon glyphicon-minus" aria-hidden="true"></span>'),closedIcon:$('<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>'),onCreateLi:function(node,$li){if('order'===node.sector){$li.find('.jqtree-element').append('<span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span>');}
if('project'===node.sector){$li.find('.jqtree-title').html('<span class="glyphicon glyphicon-folder-close" aria-hidden="true">&nbsp;</span>'+$li.find('.jqtree-title').text());}
if('client'===node.sector){$li.find('.jqtree-title').closest('li').addClass('clientInTree');$li.find('.jqtree-title').html('<span class="glyphicon glyphicon-user" aria-hidden="true">&nbsp;</span>'+$li.find('.jqtree-title').text());}}});tree.bind('tree.click',function(event){var node=event.node;$('#clientsTree').tree('selectNode');CLIENTS.currentClietsTreeSectionAction(node);});}
var selectedNode=tree.tree('getSelectedNode');CLIENTS.currentClietsTreeSectionAction(selectedNode);});},currentClietsTreeSectionAction:function(node){switch(node.sector){case'client':MENU.fillFormOfClientsInfo(node.info);break;case'project':MENU.fillFormOfProjectInfo(node.info);break;case'order':TABS.getRightTabContentOrderDetails(node.orderId);TABS.getRightTabContentTable(node.orderId);MAIN.orderId=node.orderId;break;}},deleteClient:function(id){$.ajax({url:URL_CLIENTS+'deleteClient',method:'POST',data:{id:id}}).then(function(data)
{CLIENTS.getClientsTree(true);});},deleteProject:function(id){$.ajax({url:URL_CLIENTS+'deleteProject',method:'POST',data:{id:id}}).then(function(data)
{CLIENTS.getClientsTree(true);});}},themes:{addTheme:function(){return $.ajax({url:URL_THEMES+'addTheme',method:'POST',data:{name:$('#customThemeName').val()}}).then(function(data)
{return data;});},getThemesList:function(){$.ajax({url:URL_THEMES+'getThemesList',method:'GET'}).then(function(data)
{$('#customThemesList').html(data.html);MAIN.themesList=data.list;var activeTheme=MAIN.themesList['1'];if(_.size(activeTheme)&&null!==activeTheme[_.keys(activeTheme)]){localStorage.customCSS=activeTheme[_.keys(activeTheme)];PREFERENCES.applyCss();}else{localStorage.customCSS='{}';}});},applyTheme:function(){var theme=$('#customThemesList option:selected').val();$.ajax({url:URL_THEMES+'applyThemes',method:'POST',data:{theme:theme}}).then(function(data)
{if('default'===theme){delete localStorage.customCSS;window.location.href=LOCATION;}else{localStorage.customCSS=null!==data.css?data.css:'{}';PREFERENCES.applyCss();}});},deleteTheme:function(){var theme=$('#customThemesList option:selected').val();if('default'!==theme){$.ajax({url:URL_THEMES+'deleteThemes',method:'POST',data:{theme:theme}}).then(function(data)
{delete localStorage.customCSS;window.location.href=LOCATION;});}},addThemeCss:function(css){var theme=$('#customThemesList option:selected').val();if('default'!==theme){$.ajax({url:URL_THEMES+'addThemeCss',method:'POST',data:{theme:theme,css:css}}).then(function(data)
{if(data){localStorage.customCSS=JSON.stringify(css);}});}}}};Dima.init=function(){this.main={};SELF=this;MAIN=this.main,TABS=this.tabs;ORDER=this.order;PRODUCT=this.product;CATEGORIES=this.categories;KIM=this.kim;METALLS=this.metalls;MENU=this.menu;PREFERENCES=this.preferences;VALIDATION=this.validation;THEMES=this.themes;CLIENTS=this.clients;run();};Dima.init.prototype=Dima.prototype;global.Dima=global.D$=Dima;}(window,jQuery));;'use strict';$(document).ready(function()
{var d=D$(),MAIN=d.main,TABS=d.tabs,ORDER=d.order,PRODUCT=d.product,CATEGORIES=d.categories,KIM=d.kim,METALLS=d.metalls,MENU=d.menu,PREFERENCES=d.preferences,VALID=d.validation,THEMES=d.themes,LOCATION='http://DimaPhalcon/DimaPhalcon/',defaultScreenSize='60em',maxScreenSize=(window.screen.availWidth-5)+'px',minscreenSize='5px';PREFERENCES.applyCss();$('#livemill').prop('muted',true);if(undefined===localStorage.split){localStorage.split=defaultScreenSize;}
if(undefined===localStorage['db-split']){localStorage['db-split']=defaultScreenSize;}
TABS.splitMonitor();$('#creatingProductsWrapper, #databaseWrapper').splitPane();$('#divider').on('mouseleave',function(){localStorage.split=$('#divider').css('left');});$('#db-divider').on('mouseleave',function(){localStorage['db-split']=$('#db-divider').css('left');});$('#tabsRight').on('dblclick','#rightTabs li',function(){localStorage.split===minscreenSize?localStorage.split=defaultScreenSize:localStorage.split=minscreenSize;TABS.splitMonitor();});$('#tabs').on('dblclick','#myTab li',function(){localStorage['db-split']===maxScreenSize?localStorage['db-split']=defaultScreenSize:localStorage['db-split']=maxScreenSize;TABS.splitMonitor();});PREFERENCES.insertFontSizes(['#globalFontSize'],'body');$('#globalFontSize').change(function(){var css=PREFERENCES.checkStorageCSS('body');$('body').css('font-size',$('#globalFontSize :selected').text());css.body['font-size']=$('#globalFontSize :selected').text();localStorage.customCSS=JSON.stringify(css);});PREFERENCES.insertFontSizes(['#fontSizeTabs'],'.nav-tabs');$('#fontSizeTabs').change(function(){var css=PREFERENCES.checkStorageCSS('.nav-tabs');$('#testTab').css('font-size',$('#fontSizeTabs :selected').text());css['.nav-tabs']['font-size']=$('#fontSizeTabs :selected').text();localStorage.customCSS=JSON.stringify(css);});PREFERENCES.applyPreferences(MENU.getPreferencesSettings());$('#addThemeBtn').click(function(){if($('#customThemeName').val()){$.when(THEMES.addTheme()).then(function(data){if(data){$('#customThemeName').val('');THEMES.getThemesList();}else{VALID.showError('#customThemeName');}});}});$('#applyThemeBtn').click(THEMES.applyTheme);$('#deleteThemeBtn').click(THEMES.deleteTheme);$('#runPR').click(function(){$('#mainMenuWrapper').fadeOut();if(!MAIN.prRequested){setTimeout(MENU.runProductCreation,500);}else{setTimeout(MENU.runProductCreation,300);}});$('#runDB').click(function(){$('#mainMenuWrapper').fadeOut();setTimeout(MENU.runDB,300);});$('#runPreferences').click(function(){$('#mainMenuWrapper').fadeOut();setTimeout(MENU.runPreferences,300);});$('#backIcon, #dbIcon, #prefIcon, #menuOpen, #prIcon').mouseenter(function(){if('dbIcon'===$(this).attr('id')){$('span',this).removeClass().addClass('glyphicon glyphicon-folder-open centerIcon');}}).mouseleave(function(){if('MENU'!==localStorage.siteSector){if('dbIcon'===$(this).attr('id')){$('span',this).removeClass().addClass('glyphicon glyphicon-folder-close centerIcon');}}});$('#customThemesWrapper').mouseenter(function(){MENU.onHoverElement({scope:this,css:{"marginLeft":"0px"},speed:250});$('#showCustomThemes span',this).removeClass().addClass('glyphicon glyphicon-backward');}).mouseleave(function(){if('MENU'!==localStorage.siteSector){MENU.onHoverElement({scope:this,css:{"marginLeft":"-200px"},speed:200});}
$('#showCustomThemes span',this).removeClass().addClass('glyphicon glyphicon-forward');});$('#backIcon').click(function(){delete localStorage.siteSector;window.location.href=LOCATION;});$('#prefIcon').click(MENU.runPreferences);$('#dbIcon').click(function(){if('DB'!==localStorage.siteSector){localStorage.siteSector='DB';window.location.href=LOCATION;}});$('#menuOpen').click(function(){MENU.createFileManager();});$('#prIcon').click(function(){if('OR'!==localStorage.siteSector){localStorage.siteSector='OR';window.location.href=LOCATION;}});$('#showItemFromFileManager').click(function(){var product=[];var order=[];$(this).hide();$.each($('.openProductTabSelected'),function(num,obj){if('product'===$(obj).attr('data-type')){product.push($(obj).attr('data-id'));}
if('order'===$(obj).attr('data-type')){order.push($(obj).attr('data-id'));}});$.when(TABS.openSavedProduct(product,'new',false,false),ORDER.openSavedOrder(order,'new',false,false)).done(function(){window.location.href=LOCATION;});});$('#FMconsolidatedOrdersBtn').click(function(){var orderId=[];$.each($('.consolidateOrderSelected'),function(num,obj){orderId.push($(obj).attr('data-id'));});$.when(ORDER.createNewOrder(false,true)).then(function(data){console.log(data);if(false!==data){ORDER.addToConsolidateOrder(data,orderId);}});});$('#dbProductsListTab').click(function(){TABS.setActiveDefaultTab('tabsList','dbProductsListTab','curTabId');TABS.changeActiveTab('','','changeActiveLeftTab');MENU.createFileManager('PR');});$('#addNewTab').on('click',function(){TABS.getLastLeftTab();});$('#addNewTabRight').click(function(){ORDER.createNewOrder();});$('#fileManagerOrdersTab').on('click',function(){if(false===$('#fileManagerOrdersTab').hasClass('active')){MENU.getClientsTree();TABS.setActiveDefaultTab('tabsRightList','fileManagerOrdersTab','curTabRightId');TABS.changeActiveTab('','','changeActiveRightTab');}});$('#addCategoryBtn').click(function(){var category=VALID.validateInputVal({val:$('#addCategoryInput').val(),id:'#addCategoryInput',unique:true}),article=VALID.validateInputVal({val:$('#addCategoryArticleInput').val(),id:'#addCategoryArticleInput',unique:true});if(category&&article){CATEGORIES.addCategory(category,article);}});$('#addKIM').click(function(){var kim=VALID.validateInputVal({val:$('#kimInput').val(),id:'#kimInput',digitsOnly:true}),kimHardInput=VALID.validateInputVal({val:$('#kimHardInput').val(),id:'#kimHardInput'});if(kim&&kimHardInput){KIM.addKIMtoTable(kim,kimHardInput);}});$('#addMetall').on('click',function(){;var metall=VALID.validateInputVal({val:$('#metallName').val(),id:'#metallName',unique:true}),price=VALID.validateInputVal({val:$('#metallPrice').val(),id:'#metallPrice',digitsOnly:true}),mass=VALID.validateInputVal({val:$('#metallMass').val(),id:'#metallMass',digitsOnly:true}),outPrice=VALID.validateInputVal({val:$('#metallOutPrice').val(),id:'#metallOutPrice',digitsOnly:true}),article=VALID.validateInputVal({val:$('#metallArticle').val(),id:'#metallArticle',unique:true});if(metall&&price&&mass&&outPrice&&article){METALLS.addMetallToTable({metall:metall,price:price,mass:mass,outPrice:outPrice,article:article});}});$('#fileManagerCatogoriesSelect').on('change',function(){var category=$('option:selected',this).attr('name');$.each($('.prManProductTableCategory'),function(){$(this).parent().show();if($(this).attr('name')!==category&&'categoriesAll'!==category){$(this).parent().hide();}});});$('.FMorderFilter').change(function(){var compareObj={},rows=$('#fileManagerOrdersTable tr:gt(0)'),searchText='';$.each($('.FMorderFilter'),function(num,obj){if($('option:selected',obj).text()){compareObj[$(obj).attr('data-section')]=$('option:selected',obj).text();}});searchText=_.values(compareObj).join('');if(!searchText){rows.show();}else{rows.hide();$.each($('.FMorderFullInfo'),function(num,obj){var infoOnj=JSON.parse($(obj).text()),compareText='';$.each(compareObj,function(section,text){if(text===infoOnj[section]){compareText+=text;}});if(compareText===searchText){$(obj).closest('tr').show();}});}});$('#FMsearchInProducts').keyup(function(){var text=$(this).val(),rows=$('#fileManagerProductsTable tr:gt(0)');MENU.searchInTable(rows,text,'tr');});$('#FMsearchInOrders').keyup(function(){var text=$(this).val(),rows=$('#fileManagerOrdersTable tr:gt(0)');MENU.searchInTable(rows,text,'tr');});PREFERENCES.applyCss();});;/*!

Split Pane v0.8.0

Copyright (c) 2014 Simon Hagström

Released under the MIT license
https://raw.github.com/shagstrom/split-pane/master/LICENSE

*/
!function(t){"use strict";function e(){var e=t(this),i=h(e);e.is(".fixed-top, .fixed-bottom, .horizontal-percent")?e.css("min-height",c(i.first)+c(i.last)+t(i.divider).height()+"px"):e.css("min-width",u(i.first)+u(i.last)+t(i.divider).width()+"px")}function i(e){var i=t(this),n=i.parent(),r=i.siblings(".split-pane-resize-shim");r.show(),i.addClass("dragged"),e.type.match(/^touch/)&&i.addClass("touch");var o=f(n,g(e),v(e));t(document).on("touchmove mousemove",o),t(document).one("touchend mouseup",function(e){t(document).off("touchmove mousemove",o),i.removeClass("dragged touch"),r.hide(),n.trigger("dividerdragend",[s(n)])}),n.trigger("dividerdragstart",[s(n)])}function s(t){var e=t.is(".fixed-top, .fixed-bottom, .horizontal-percent")?"height":"width";return{firstComponentSize:t.find(".split-pane-component:first")[e](),lastComponentSize:t.find(".split-pane-component:last")[e]()}}function n(t){var e=h(t);return t.is(".fixed-top")?function(i){var s=c(e.last),n=e.splitPane.offsetHeight-s-e.divider.offsetHeight;e.first.offsetHeight>n&&H(e,n+"px"),t.trigger("splitpaneresize")}:t.is(".fixed-bottom")?function(i){var s=c(e.first),n=e.splitPane.offsetHeight-s-e.divider.offsetHeight;e.last.offsetHeight>n&&P(e,n+"px"),t.trigger("splitpaneresize")}:t.is(".horizontal-percent")?function(i){var s=c(e.last),n=c(e.first),f=e.splitPane.offsetHeight-n-e.divider.offsetHeight;e.last.offsetHeight>f?P(e,f/e.splitPane.offsetHeight*100+"%"):e.splitPane.offsetHeight-e.first.offsetHeight-e.divider.offsetHeight<s&&P(e,s/e.splitPane.offsetHeight*100+"%"),t.trigger("splitpaneresize")}:t.is(".fixed-left")?function(i){var s=u(e.last),n=e.splitPane.offsetWidth-s-e.divider.offsetWidth;e.first.offsetWidth>n&&W(e,n+"px"),t.trigger("splitpaneresize")}:t.is(".fixed-right")?function(i){var s=u(e.first),n=e.splitPane.offsetWidth-s-e.divider.offsetWidth;e.last.offsetWidth>n&&z(e,n+"px"),t.trigger("splitpaneresize")}:t.is(".vertical-percent")?function(i){var s=u(e.last),n=u(e.first),f=e.splitPane.offsetWidth-n-e.divider.offsetWidth;e.last.offsetWidth>f?z(e,f/e.splitPane.offsetWidth*100+"%"):e.splitPane.offsetWidth-e.first.offsetWidth-e.divider.offsetWidth<s&&z(e,s/e.splitPane.offsetWidth*100+"%"),t.trigger("splitpaneresize")}:void 0}function f(t,e,i){var s=h(t);return t.is(".fixed-top")?r(s,i):t.is(".fixed-bottom")?o(s,i):t.is(".horizontal-percent")?a(s,i):t.is(".fixed-left")?d(s,e):t.is(".fixed-right")?p(s,e):t.is(".vertical-percent")?l(s,e):void 0}function r(e,i){var s=c(e.first),n=e.splitPane.offsetHeight-c(e.last)-e.divider.offsetHeight,f=e.divider.offsetTop-i;return function(i){var r=m(s,n,f+v(i));H(e,r+"px"),t(e.splitPane).trigger("splitpaneresize")}}function o(e,i){var s=c(e.last),n=e.splitPane.offsetHeight-c(e.first)-e.divider.offsetHeight,f=e.last.offsetHeight+i;return function(i){i.preventDefault&&i.preventDefault();var r=Math.min(Math.max(s,f-v(i)),n);P(e,r+"px"),t(e.splitPane).trigger("splitpaneresize")}}function a(e,i){var s=e.splitPane.offsetHeight,n=c(e.last),f=s-c(e.first)-e.divider.offsetHeight,r=e.last.offsetHeight+i;return function(i){i.preventDefault&&i.preventDefault();var o=Math.min(Math.max(n,r-v(i)),f);P(e,o/s*100+"%"),t(e.splitPane).trigger("splitpaneresize")}}function d(e,i){var s=u(e.first),n=e.splitPane.offsetWidth-u(e.last)-e.divider.offsetWidth,f=e.divider.offsetLeft-i;return function(i){i.preventDefault&&i.preventDefault();var r=x(s,n,f+g(i));W(e,r+"px"),t(e.splitPane).trigger("splitpaneresize")}}function p(e,i){var s=u(e.last),n=e.splitPane.offsetWidth-u(e.first)-e.divider.offsetWidth,f=e.last.offsetWidth+i;return function(i){i.preventDefault&&i.preventDefault();var r=Math.min(Math.max(s,f-g(i)),n);z(e,r+"px"),t(e.splitPane).trigger("splitpaneresize")}}function l(e,i){var s=e.splitPane.offsetWidth,n=u(e.last),f=s-u(e.first)-e.divider.offsetWidth,r=e.last.offsetWidth+i;return function(i){i.preventDefault&&i.preventDefault();var o=Math.min(Math.max(n,r-g(i)),f);z(e,o/s*100+"%"),t(e.splitPane).trigger("splitpaneresize")}}function h(t){return{splitPane:t[0],first:t.children(".split-pane-component:first")[0],divider:t.children(".split-pane-divider")[0],last:t.children(".split-pane-component:last")[0]}}function g(t){return void 0!==t.pageX?t.pageX:void 0!==t.originalEvent.pageX?t.originalEvent.pageX:t.originalEvent.touches?t.originalEvent.touches[0].pageX:void 0}function v(t){return void 0!==t.pageY?t.pageY:void 0!==t.originalEvent.pageY?t.originalEvent.pageY:t.originalEvent.touches?t.originalEvent.touches[0].pageY:void 0}function c(e){return parseInt(t(e).css("min-height"))||0}function u(e){return parseInt(t(e).css("min-width"))||0}function m(t,e,i){return Math.min(Math.max(t,i),e)}function x(t,e,i){return Math.min(Math.max(t,i),e)}function H(t,e){t.first.style.height=e,t.divider.style.top=e,t.last.style.top=e}function P(t,e){t.first.style.bottom=e,t.divider.style.bottom=e,t.last.style.height=e}function W(t,e){t.first.style.width=e,t.divider.style.left=e,t.last.style.left=e}function z(t,e){t.first.style.right=e,t.divider.style.right=e,t.last.style.width=e}var w={};w.init=function(){var s=this;s.each(e),s.append('<div class="split-pane-resize-shim">'),s.children(".split-pane-divider").html('<div class="split-pane-divider-inner"></div>'),s.children(".split-pane-divider").on("touchstart mousedown",i),setTimeout(function(){s.each(function(){var e=n(t(this)),i=t(this).parent().closest(".split-pane")[0]||window;t(i).on(i===window?"resize":"splitpaneresize",function(t){var s=t.target===document?window:t.target;s===i&&e(t)})}),t(window).trigger("resize")},100)},w.firstComponentSize=function(e){this.each(function(){var i=t(this),s=h(i);i.is(".fixed-top")?r(s,s.divider.offsetTop)({pageY:e}):i.is(".fixed-bottom")?(e=s.splitPane.offsetHeight-s.divider.offsetHeight-e,o(s,-s.last.offsetHeight)({pageY:-e})):i.is(".horizontal-percent")?(e=s.splitPane.offsetHeight-s.divider.offsetHeight-e,a(s,-s.last.offsetHeight)({pageY:-e})):i.is(".fixed-left")?d(s,s.divider.offsetLeft)({pageX:e}):i.is(".fixed-right")?(e=s.splitPane.offsetWidth-s.divider.offsetWidth-e,p(s,-s.last.offsetWidth)({pageX:-e})):i.is(".vertical-percent")&&(e=s.splitPane.offsetWidth-s.divider.offsetWidth-e,l(s,-s.last.offsetWidth)({pageX:-e}))})},w.lastComponentSize=function(e){this.each(function(){var i=t(this),s=h(i);i.is(".fixed-top")?(e=s.splitPane.offsetHeight-s.divider.offsetHeight-e,r(s,s.divider.offsetTop)({pageY:e})):i.is(".fixed-bottom")?o(s,-s.last.offsetHeight)({pageY:-e}):i.is(".horizontal-percent")?a(s,-s.last.offsetHeight)({pageY:-e}):i.is(".fixed-left")?(e=s.splitPane.offsetWidth-s.divider.offsetWidth-e,d(s,s.divider.offsetLeft)({pageX:e})):i.is(".fixed-right")?p(s,-s.last.offsetWidth)({pageX:-e}):i.is(".vertical-percent")&&l(s,-s.last.offsetWidth)({pageX:-e})})},t.fn.splitPane=function(e){w[e||"init"].apply(this,t.grep(arguments,function(t,e){return e>0}))}}(jQuery);
//     Underscore.js 1.8.3
//     http://underscorejs.org
//     (c) 2009-2015 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Underscore may be freely distributed under the MIT license.
(function(){function n(n){function t(t,r,e,u,i,o){for(;i>=0&&o>i;i+=n){var a=u?u[i]:i;e=r(e,t[a],a,t)}return e}return function(r,e,u,i){e=b(e,i,4);var o=!k(r)&&m.keys(r),a=(o||r).length,c=n>0?0:a-1;return arguments.length<3&&(u=r[o?o[c]:c],c+=n),t(r,e,u,o,c,a)}}function t(n){return function(t,r,e){r=x(r,e);for(var u=O(t),i=n>0?0:u-1;i>=0&&u>i;i+=n)if(r(t[i],i,t))return i;return-1}}function r(n,t,r){return function(e,u,i){var o=0,a=O(e);if("number"==typeof i)n>0?o=i>=0?i:Math.max(i+a,o):a=i>=0?Math.min(i+1,a):i+a+1;else if(r&&i&&a)return i=r(e,u),e[i]===u?i:-1;if(u!==u)return i=t(l.call(e,o,a),m.isNaN),i>=0?i+o:-1;for(i=n>0?o:a-1;i>=0&&a>i;i+=n)if(e[i]===u)return i;return-1}}function e(n,t){var r=I.length,e=n.constructor,u=m.isFunction(e)&&e.prototype||a,i="constructor";for(m.has(n,i)&&!m.contains(t,i)&&t.push(i);r--;)i=I[r],i in n&&n[i]!==u[i]&&!m.contains(t,i)&&t.push(i)}var u=this,i=u._,o=Array.prototype,a=Object.prototype,c=Function.prototype,f=o.push,l=o.slice,s=a.toString,p=a.hasOwnProperty,h=Array.isArray,v=Object.keys,g=c.bind,y=Object.create,d=function(){},m=function(n){return n instanceof m?n:this instanceof m?void(this._wrapped=n):new m(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=m),exports._=m):u._=m,m.VERSION="1.8.3";var b=function(n,t,r){if(t===void 0)return n;switch(null==r?3:r){case 1:return function(r){return n.call(t,r)};case 2:return function(r,e){return n.call(t,r,e)};case 3:return function(r,e,u){return n.call(t,r,e,u)};case 4:return function(r,e,u,i){return n.call(t,r,e,u,i)}}return function(){return n.apply(t,arguments)}},x=function(n,t,r){return null==n?m.identity:m.isFunction(n)?b(n,t,r):m.isObject(n)?m.matcher(n):m.property(n)};m.iteratee=function(n,t){return x(n,t,1/0)};var _=function(n,t){return function(r){var e=arguments.length;if(2>e||null==r)return r;for(var u=1;e>u;u++)for(var i=arguments[u],o=n(i),a=o.length,c=0;a>c;c++){var f=o[c];t&&r[f]!==void 0||(r[f]=i[f])}return r}},j=function(n){if(!m.isObject(n))return{};if(y)return y(n);d.prototype=n;var t=new d;return d.prototype=null,t},w=function(n){return function(t){return null==t?void 0:t[n]}},A=Math.pow(2,53)-1,O=w("length"),k=function(n){var t=O(n);return"number"==typeof t&&t>=0&&A>=t};m.each=m.forEach=function(n,t,r){t=b(t,r);var e,u;if(k(n))for(e=0,u=n.length;u>e;e++)t(n[e],e,n);else{var i=m.keys(n);for(e=0,u=i.length;u>e;e++)t(n[i[e]],i[e],n)}return n},m.map=m.collect=function(n,t,r){t=x(t,r);for(var e=!k(n)&&m.keys(n),u=(e||n).length,i=Array(u),o=0;u>o;o++){var a=e?e[o]:o;i[o]=t(n[a],a,n)}return i},m.reduce=m.foldl=m.inject=n(1),m.reduceRight=m.foldr=n(-1),m.find=m.detect=function(n,t,r){var e;return e=k(n)?m.findIndex(n,t,r):m.findKey(n,t,r),e!==void 0&&e!==-1?n[e]:void 0},m.filter=m.select=function(n,t,r){var e=[];return t=x(t,r),m.each(n,function(n,r,u){t(n,r,u)&&e.push(n)}),e},m.reject=function(n,t,r){return m.filter(n,m.negate(x(t)),r)},m.every=m.all=function(n,t,r){t=x(t,r);for(var e=!k(n)&&m.keys(n),u=(e||n).length,i=0;u>i;i++){var o=e?e[i]:i;if(!t(n[o],o,n))return!1}return!0},m.some=m.any=function(n,t,r){t=x(t,r);for(var e=!k(n)&&m.keys(n),u=(e||n).length,i=0;u>i;i++){var o=e?e[i]:i;if(t(n[o],o,n))return!0}return!1},m.contains=m.includes=m.include=function(n,t,r,e){return k(n)||(n=m.values(n)),("number"!=typeof r||e)&&(r=0),m.indexOf(n,t,r)>=0},m.invoke=function(n,t){var r=l.call(arguments,2),e=m.isFunction(t);return m.map(n,function(n){var u=e?t:n[t];return null==u?u:u.apply(n,r)})},m.pluck=function(n,t){return m.map(n,m.property(t))},m.where=function(n,t){return m.filter(n,m.matcher(t))},m.findWhere=function(n,t){return m.find(n,m.matcher(t))},m.max=function(n,t,r){var e,u,i=-1/0,o=-1/0;if(null==t&&null!=n){n=k(n)?n:m.values(n);for(var a=0,c=n.length;c>a;a++)e=n[a],e>i&&(i=e)}else t=x(t,r),m.each(n,function(n,r,e){u=t(n,r,e),(u>o||u===-1/0&&i===-1/0)&&(i=n,o=u)});return i},m.min=function(n,t,r){var e,u,i=1/0,o=1/0;if(null==t&&null!=n){n=k(n)?n:m.values(n);for(var a=0,c=n.length;c>a;a++)e=n[a],i>e&&(i=e)}else t=x(t,r),m.each(n,function(n,r,e){u=t(n,r,e),(o>u||1/0===u&&1/0===i)&&(i=n,o=u)});return i},m.shuffle=function(n){for(var t,r=k(n)?n:m.values(n),e=r.length,u=Array(e),i=0;e>i;i++)t=m.random(0,i),t!==i&&(u[i]=u[t]),u[t]=r[i];return u},m.sample=function(n,t,r){return null==t||r?(k(n)||(n=m.values(n)),n[m.random(n.length-1)]):m.shuffle(n).slice(0,Math.max(0,t))},m.sortBy=function(n,t,r){return t=x(t,r),m.pluck(m.map(n,function(n,r,e){return{value:n,index:r,criteria:t(n,r,e)}}).sort(function(n,t){var r=n.criteria,e=t.criteria;if(r!==e){if(r>e||r===void 0)return 1;if(e>r||e===void 0)return-1}return n.index-t.index}),"value")};var F=function(n){return function(t,r,e){var u={};return r=x(r,e),m.each(t,function(e,i){var o=r(e,i,t);n(u,e,o)}),u}};m.groupBy=F(function(n,t,r){m.has(n,r)?n[r].push(t):n[r]=[t]}),m.indexBy=F(function(n,t,r){n[r]=t}),m.countBy=F(function(n,t,r){m.has(n,r)?n[r]++:n[r]=1}),m.toArray=function(n){return n?m.isArray(n)?l.call(n):k(n)?m.map(n,m.identity):m.values(n):[]},m.size=function(n){return null==n?0:k(n)?n.length:m.keys(n).length},m.partition=function(n,t,r){t=x(t,r);var e=[],u=[];return m.each(n,function(n,r,i){(t(n,r,i)?e:u).push(n)}),[e,u]},m.first=m.head=m.take=function(n,t,r){return null==n?void 0:null==t||r?n[0]:m.initial(n,n.length-t)},m.initial=function(n,t,r){return l.call(n,0,Math.max(0,n.length-(null==t||r?1:t)))},m.last=function(n,t,r){return null==n?void 0:null==t||r?n[n.length-1]:m.rest(n,Math.max(0,n.length-t))},m.rest=m.tail=m.drop=function(n,t,r){return l.call(n,null==t||r?1:t)},m.compact=function(n){return m.filter(n,m.identity)};var S=function(n,t,r,e){for(var u=[],i=0,o=e||0,a=O(n);a>o;o++){var c=n[o];if(k(c)&&(m.isArray(c)||m.isArguments(c))){t||(c=S(c,t,r));var f=0,l=c.length;for(u.length+=l;l>f;)u[i++]=c[f++]}else r||(u[i++]=c)}return u};m.flatten=function(n,t){return S(n,t,!1)},m.without=function(n){return m.difference(n,l.call(arguments,1))},m.uniq=m.unique=function(n,t,r,e){m.isBoolean(t)||(e=r,r=t,t=!1),null!=r&&(r=x(r,e));for(var u=[],i=[],o=0,a=O(n);a>o;o++){var c=n[o],f=r?r(c,o,n):c;t?(o&&i===f||u.push(c),i=f):r?m.contains(i,f)||(i.push(f),u.push(c)):m.contains(u,c)||u.push(c)}return u},m.union=function(){return m.uniq(S(arguments,!0,!0))},m.intersection=function(n){for(var t=[],r=arguments.length,e=0,u=O(n);u>e;e++){var i=n[e];if(!m.contains(t,i)){for(var o=1;r>o&&m.contains(arguments[o],i);o++);o===r&&t.push(i)}}return t},m.difference=function(n){var t=S(arguments,!0,!0,1);return m.filter(n,function(n){return!m.contains(t,n)})},m.zip=function(){return m.unzip(arguments)},m.unzip=function(n){for(var t=n&&m.max(n,O).length||0,r=Array(t),e=0;t>e;e++)r[e]=m.pluck(n,e);return r},m.object=function(n,t){for(var r={},e=0,u=O(n);u>e;e++)t?r[n[e]]=t[e]:r[n[e][0]]=n[e][1];return r},m.findIndex=t(1),m.findLastIndex=t(-1),m.sortedIndex=function(n,t,r,e){r=x(r,e,1);for(var u=r(t),i=0,o=O(n);o>i;){var a=Math.floor((i+o)/2);r(n[a])<u?i=a+1:o=a}return i},m.indexOf=r(1,m.findIndex,m.sortedIndex),m.lastIndexOf=r(-1,m.findLastIndex),m.range=function(n,t,r){null==t&&(t=n||0,n=0),r=r||1;for(var e=Math.max(Math.ceil((t-n)/r),0),u=Array(e),i=0;e>i;i++,n+=r)u[i]=n;return u};var E=function(n,t,r,e,u){if(!(e instanceof t))return n.apply(r,u);var i=j(n.prototype),o=n.apply(i,u);return m.isObject(o)?o:i};m.bind=function(n,t){if(g&&n.bind===g)return g.apply(n,l.call(arguments,1));if(!m.isFunction(n))throw new TypeError("Bind must be called on a function");var r=l.call(arguments,2),e=function(){return E(n,e,t,this,r.concat(l.call(arguments)))};return e},m.partial=function(n){var t=l.call(arguments,1),r=function(){for(var e=0,u=t.length,i=Array(u),o=0;u>o;o++)i[o]=t[o]===m?arguments[e++]:t[o];for(;e<arguments.length;)i.push(arguments[e++]);return E(n,r,this,this,i)};return r},m.bindAll=function(n){var t,r,e=arguments.length;if(1>=e)throw new Error("bindAll must be passed function names");for(t=1;e>t;t++)r=arguments[t],n[r]=m.bind(n[r],n);return n},m.memoize=function(n,t){var r=function(e){var u=r.cache,i=""+(t?t.apply(this,arguments):e);return m.has(u,i)||(u[i]=n.apply(this,arguments)),u[i]};return r.cache={},r},m.delay=function(n,t){var r=l.call(arguments,2);return setTimeout(function(){return n.apply(null,r)},t)},m.defer=m.partial(m.delay,m,1),m.throttle=function(n,t,r){var e,u,i,o=null,a=0;r||(r={});var c=function(){a=r.leading===!1?0:m.now(),o=null,i=n.apply(e,u),o||(e=u=null)};return function(){var f=m.now();a||r.leading!==!1||(a=f);var l=t-(f-a);return e=this,u=arguments,0>=l||l>t?(o&&(clearTimeout(o),o=null),a=f,i=n.apply(e,u),o||(e=u=null)):o||r.trailing===!1||(o=setTimeout(c,l)),i}},m.debounce=function(n,t,r){var e,u,i,o,a,c=function(){var f=m.now()-o;t>f&&f>=0?e=setTimeout(c,t-f):(e=null,r||(a=n.apply(i,u),e||(i=u=null)))};return function(){i=this,u=arguments,o=m.now();var f=r&&!e;return e||(e=setTimeout(c,t)),f&&(a=n.apply(i,u),i=u=null),a}},m.wrap=function(n,t){return m.partial(t,n)},m.negate=function(n){return function(){return!n.apply(this,arguments)}},m.compose=function(){var n=arguments,t=n.length-1;return function(){for(var r=t,e=n[t].apply(this,arguments);r--;)e=n[r].call(this,e);return e}},m.after=function(n,t){return function(){return--n<1?t.apply(this,arguments):void 0}},m.before=function(n,t){var r;return function(){return--n>0&&(r=t.apply(this,arguments)),1>=n&&(t=null),r}},m.once=m.partial(m.before,2);var M=!{toString:null}.propertyIsEnumerable("toString"),I=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];m.keys=function(n){if(!m.isObject(n))return[];if(v)return v(n);var t=[];for(var r in n)m.has(n,r)&&t.push(r);return M&&e(n,t),t},m.allKeys=function(n){if(!m.isObject(n))return[];var t=[];for(var r in n)t.push(r);return M&&e(n,t),t},m.values=function(n){for(var t=m.keys(n),r=t.length,e=Array(r),u=0;r>u;u++)e[u]=n[t[u]];return e},m.mapObject=function(n,t,r){t=x(t,r);for(var e,u=m.keys(n),i=u.length,o={},a=0;i>a;a++)e=u[a],o[e]=t(n[e],e,n);return o},m.pairs=function(n){for(var t=m.keys(n),r=t.length,e=Array(r),u=0;r>u;u++)e[u]=[t[u],n[t[u]]];return e},m.invert=function(n){for(var t={},r=m.keys(n),e=0,u=r.length;u>e;e++)t[n[r[e]]]=r[e];return t},m.functions=m.methods=function(n){var t=[];for(var r in n)m.isFunction(n[r])&&t.push(r);return t.sort()},m.extend=_(m.allKeys),m.extendOwn=m.assign=_(m.keys),m.findKey=function(n,t,r){t=x(t,r);for(var e,u=m.keys(n),i=0,o=u.length;o>i;i++)if(e=u[i],t(n[e],e,n))return e},m.pick=function(n,t,r){var e,u,i={},o=n;if(null==o)return i;m.isFunction(t)?(u=m.allKeys(o),e=b(t,r)):(u=S(arguments,!1,!1,1),e=function(n,t,r){return t in r},o=Object(o));for(var a=0,c=u.length;c>a;a++){var f=u[a],l=o[f];e(l,f,o)&&(i[f]=l)}return i},m.omit=function(n,t,r){if(m.isFunction(t))t=m.negate(t);else{var e=m.map(S(arguments,!1,!1,1),String);t=function(n,t){return!m.contains(e,t)}}return m.pick(n,t,r)},m.defaults=_(m.allKeys,!0),m.create=function(n,t){var r=j(n);return t&&m.extendOwn(r,t),r},m.clone=function(n){return m.isObject(n)?m.isArray(n)?n.slice():m.extend({},n):n},m.tap=function(n,t){return t(n),n},m.isMatch=function(n,t){var r=m.keys(t),e=r.length;if(null==n)return!e;for(var u=Object(n),i=0;e>i;i++){var o=r[i];if(t[o]!==u[o]||!(o in u))return!1}return!0};var N=function(n,t,r,e){if(n===t)return 0!==n||1/n===1/t;if(null==n||null==t)return n===t;n instanceof m&&(n=n._wrapped),t instanceof m&&(t=t._wrapped);var u=s.call(n);if(u!==s.call(t))return!1;switch(u){case"[object RegExp]":case"[object String]":return""+n==""+t;case"[object Number]":return+n!==+n?+t!==+t:0===+n?1/+n===1/t:+n===+t;case"[object Date]":case"[object Boolean]":return+n===+t}var i="[object Array]"===u;if(!i){if("object"!=typeof n||"object"!=typeof t)return!1;var o=n.constructor,a=t.constructor;if(o!==a&&!(m.isFunction(o)&&o instanceof o&&m.isFunction(a)&&a instanceof a)&&"constructor"in n&&"constructor"in t)return!1}r=r||[],e=e||[];for(var c=r.length;c--;)if(r[c]===n)return e[c]===t;if(r.push(n),e.push(t),i){if(c=n.length,c!==t.length)return!1;for(;c--;)if(!N(n[c],t[c],r,e))return!1}else{var f,l=m.keys(n);if(c=l.length,m.keys(t).length!==c)return!1;for(;c--;)if(f=l[c],!m.has(t,f)||!N(n[f],t[f],r,e))return!1}return r.pop(),e.pop(),!0};m.isEqual=function(n,t){return N(n,t)},m.isEmpty=function(n){return null==n?!0:k(n)&&(m.isArray(n)||m.isString(n)||m.isArguments(n))?0===n.length:0===m.keys(n).length},m.isElement=function(n){return!(!n||1!==n.nodeType)},m.isArray=h||function(n){return"[object Array]"===s.call(n)},m.isObject=function(n){var t=typeof n;return"function"===t||"object"===t&&!!n},m.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(n){m["is"+n]=function(t){return s.call(t)==="[object "+n+"]"}}),m.isArguments(arguments)||(m.isArguments=function(n){return m.has(n,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(m.isFunction=function(n){return"function"==typeof n||!1}),m.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},m.isNaN=function(n){return m.isNumber(n)&&n!==+n},m.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"===s.call(n)},m.isNull=function(n){return null===n},m.isUndefined=function(n){return n===void 0},m.has=function(n,t){return null!=n&&p.call(n,t)},m.noConflict=function(){return u._=i,this},m.identity=function(n){return n},m.constant=function(n){return function(){return n}},m.noop=function(){},m.property=w,m.propertyOf=function(n){return null==n?function(){}:function(t){return n[t]}},m.matcher=m.matches=function(n){return n=m.extendOwn({},n),function(t){return m.isMatch(t,n)}},m.times=function(n,t,r){var e=Array(Math.max(0,n));t=b(t,r,1);for(var u=0;n>u;u++)e[u]=t(u);return e},m.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))},m.now=Date.now||function(){return(new Date).getTime()};var B={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},T=m.invert(B),R=function(n){var t=function(t){return n[t]},r="(?:"+m.keys(n).join("|")+")",e=RegExp(r),u=RegExp(r,"g");return function(n){return n=null==n?"":""+n,e.test(n)?n.replace(u,t):n}};m.escape=R(B),m.unescape=R(T),m.result=function(n,t,r){var e=null==n?void 0:n[t];return e===void 0&&(e=r),m.isFunction(e)?e.call(n):e};var q=0;m.uniqueId=function(n){var t=++q+"";return n?n+t:t},m.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var K=/(.)^/,z={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},D=/\\|'|\r|\n|\u2028|\u2029/g,L=function(n){return"\\"+z[n]};m.template=function(n,t,r){!t&&r&&(t=r),t=m.defaults({},t,m.templateSettings);var e=RegExp([(t.escape||K).source,(t.interpolate||K).source,(t.evaluate||K).source].join("|")+"|$","g"),u=0,i="__p+='";n.replace(e,function(t,r,e,o,a){return i+=n.slice(u,a).replace(D,L),u=a+t.length,r?i+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'":e?i+="'+\n((__t=("+e+"))==null?'':__t)+\n'":o&&(i+="';\n"+o+"\n__p+='"),t}),i+="';\n",t.variable||(i="with(obj||{}){\n"+i+"}\n"),i="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+i+"return __p;\n";try{var o=new Function(t.variable||"obj","_",i)}catch(a){throw a.source=i,a}var c=function(n){return o.call(this,n,m)},f=t.variable||"obj";return c.source="function("+f+"){\n"+i+"}",c},m.chain=function(n){var t=m(n);return t._chain=!0,t};var P=function(n,t){return n._chain?m(t).chain():t};m.mixin=function(n){m.each(m.functions(n),function(t){var r=m[t]=n[t];m.prototype[t]=function(){var n=[this._wrapped];return f.apply(n,arguments),P(this,r.apply(m,n))}})},m.mixin(m),m.each(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=o[n];m.prototype[n]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!==n&&"splice"!==n||0!==r.length||delete r[0],P(this,r)}}),m.each(["concat","join","slice"],function(n){var t=o[n];m.prototype[n]=function(){return P(this,t.apply(this._wrapped,arguments))}}),m.prototype.value=function(){return this._wrapped},m.prototype.valueOf=m.prototype.toJSON=m.prototype.value,m.prototype.toString=function(){return""+this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return m})}).call(this);
//# sourceMappingURL=underscore-min.map